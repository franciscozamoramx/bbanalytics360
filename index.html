<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Intelligence - Big Bola</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/PJSBFV7L/panel.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a3a8f 0%, #152c6e 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            max-width: 250px;
            margin: 0 auto 20px;
            display: block;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        p {
            font-size: 18px;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(to bottom, #FFD700, #FF8C00);
            color: #152c6e;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, #FFE600, #FF9E00);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .user-info {
            margin-top: 15px;
            font-size: 14px;
            color: #FFD700;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status-success {
            background: rgba(0, 255, 0, 0.2);
            color: #90EE90;
        }
        
        .status-error {
            background: rgba(255, 0, 0, 0.2);
            color: #FFB6C1;
        }
        
        .status-loading {
            background: rgba(255, 255, 0, 0.2);
            color: #FFD700;
        }

        @media (max-width: 600px) {
            .login-container {
                padding: 25px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            p {
                font-size: 16px;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor de login -->
    <div class="login-container" id="loginContainer">
        <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="logo">
        <h1>Centro de Business Intelligence</h1>
        <p>Ingresa con tu correo corporativo</p>
        
        <div class="login-form">
            <div class="form-group">
                <label for="email">Correo electr√≥nico:</label>
                <input type="email" id="email" placeholder="usuario@bigbola.com" required>
            </div>
            <button class="btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Ingresar al Centro de BI
            </button>
        </div>
        
        <div class="status-message" id="statusMessage" style="display: none;"></div>
        
        <div class="user-info" id="userInfo" style="display: none;">
            <p>Bienvenido: <span id="userEmail"></span></p>
            <p>Dashboards disponibles: <span id="dashboardsCount"></span></p>
        </div>
    </div>

    <script>
        // Mapeo de dashboards a URLs
        const dashboardUrls = {
            "principal": "https://app.powerbi.com/reportEmbed?reportId=9bd044c3-981b-4a9a-914a-b7bf130dae59&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "adt": "https://app.powerbi.com/reportEmbed?reportId=1149b379-aad5-4876-bfe6-c325dc89308f&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "auditoria": "https://app.powerbi.com/reportEmbed?reportId=23dbdb70-5e05-4e2f-9cf6-38a11489cd3e&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "bigplayers": "https://app.powerbi.com/reportEmbed?reportId=8e08098b-ce0e-46af-a8b5-e90b0b216e76&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "desempeno": "https://app.powerbi.com/reportEmbed?reportId=28c07103-a77e-42f4-a9ca-7d9345b48131&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "inventario": "https://app.powerbi.com/reportEmbed?reportId=4fe689c1-3fa7-4632-8367-4b7a7abc492c&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "promociones": "https://app.powerbi.com/reportEmbed?reportId=373b28bf-5d1b-46a0-b98b-4b3e378520c4&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "proyectos": "https://app.powerbi.com/reportEmbed?reportId=c2e5834e-4e3d-418c-a9dc-43e33d79a62e&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "rtp": "https://app.powerbi.com/reportEmbed?reportId=01ac285e-618f-43de-be89-d62b1a46374c&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "diccionario": "https://app.powerbi.com/reportEmbed?reportId=95918a25-c06b-411a-a346-f462b03e557b&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "seguimiento_auditores": "https://app.powerbi.com/reportEmbed?reportId=f298656f-f4fb-4110-9580-321f04c0cfd6&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
			"logs_bi": "https://app.powerbi.com/reportEmbed?reportId=36b35095-427f-4ded-82d4-27ce644ddeac&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c"
        };

        // Mapeo de nombres de dashboards
        const dashboardNames = {
            "principal": "Principal",
            "adt": "ADT",
            "auditoria": "Auditor√≠a de Salas",
            "bigplayers": "Big Player's",
            "desempeno": "Desempe√±o de M√°quinas",
            "inventario": "Inventario TI",
            "promociones": "Promociones",
            "proyectos": "Proyectos BI",
            "rtp": "RTP",
            "diccionario": "Diccionario KPI's",
            "seguimiento_auditores": "Seguimiento de Auditores",
			"logs_bi": "Logs Centro de Dashboards"
        };

        // Mapeo de √≠conos para dashboards
        const dashboardIcons = {
            "principal": "fas fa-house",
            "adt": "fas fa-chart-line",
            "auditoria": "fas fa-search",
            "bigplayers": "fas fa-gem",
            "desempeno": "fas fa-tachometer-alt",
            "inventario": "fas fa-desktop",
            "promociones": "fas fa-gift",
            "proyectos": "fas fa-project-diagram",
            "rtp": "fas fa-coins",
            "diccionario": "fas fa-book",
            "logs_bi": "fas fa-clipboard-list",
            "seguimiento_auditores": "fas fa-user-check"
        };

        // ==================== AIRTABLE LOGGER COMPLETO ====================
        const LOGGING_ENABLED = true;
        let currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let userIP = null;

        // CONFIGURACI√ìN AIRTABLE - CON TUS DATOS
        const AIRTABLE_CONFIG = {
            baseId: 'appyLYRPaDHgHRMfg', // TU BASE ID
            apiKey: 'patotjwpztoSwMBKc.19277efd2f0944e48d327235c5ecd969e1ece9b46543924225445a24d0992e23', // TU TOKEN
            tableName: 'Table 1' // Nombre de la tabla
        };

        class AirtableLogger {
            constructor() {
                this.pendingLogs = [];
                this.isOnline = navigator.onLine;
                
                // Obtener IP del usuario
                this.getUserIP();
                
                this.init();
            }
            
            async init() {
                // Detectar conexi√≥n
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.flushPendingLogs();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });
                
                // Cargar pendientes
                this.loadPendingLogs();
                
                // Sincronizar cada 30 segundos
                setInterval(() => this.flushPendingLogs(), 30000);
                
                console.log('‚úÖ Logger Airtable inicializado');
            }
            
            // Obtener IP del usuario
            async getUserIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    userIP = data.ip;
                    console.log('üåê IP obtenida:', userIP);
                } catch (error) {
                    console.warn('No se pudo obtener IP externa');
                    userIP = 'IP no disponible';
                }
            }
            
            // Detectar tipo de dispositivo
            detectDeviceType() {
                const userAgent = navigator.userAgent.toLowerCase();
                const screenWidth = window.screen.width;
                
                if (/mobile|android|iphone|ipad|ipod/.test(userAgent)) {
                    if (screenWidth >= 768) {
                        return 'tablet';
                    }
                    return 'mobile';
                }
                
                if (screenWidth >= 768 && screenWidth <= 1024) {
                    if (/android|ipad/.test(userAgent)) {
                        return 'tablet';
                    }
                }
                
                return 'desktop';
            }
            
            // Registrar evento
            async log(action, dashboard = null, user = null, extraData = {}) {
                const logEntry = {
                    id: 'log_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    timestamp: new Date().toISOString(),
                    fechaHoraLocal: new Date().toLocaleString('es-MX'),
                    user: user || currentUser || 'anonymous',
                    action: action,
                    dashboard: dashboard,
                    dashboardName: dashboard ? dashboardNames[dashboard] : null,
                    deviceType: this.detectDeviceType(),
                    screen: `${window.screen.width}x${window.screen.height}`,
                    userAgent: navigator.userAgent,
                    ip: userIP || 'Obteniendo...',
                    sessionId: currentSessionId,
                    extraData: extraData
                };
                
                console.log('üìù Registrando:', {
                    usuario: logEntry.user,
                    accion: logEntry.action,
                    dashboard: logEntry.dashboardName,
                    dispositivo: logEntry.deviceType,
                    ip: logEntry.ip,
                    extra: extraData
                });
                
                // 1. Guardar localmente
                this.saveToLocalStorage(logEntry);
                
                // 2. Intentar enviar a Airtable
                if (this.isOnline) {
                    try {
                        await this.sendToAirtable(logEntry);
                        console.log('‚úÖ Log enviado a Airtable');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error Airtable, guardando pendiente:', error.message);
                        this.saveAsPending(logEntry);
                    }
                } else {
                    this.saveAsPending(logEntry);
                    console.log('üì¶ Log guardado como pendiente (offline)');
                }
                
                return logEntry;
            }
            
            // Enviar a Airtable
            async sendToAirtable(logEntry) {
                const airtableRecord = {
                    fields: {
                        "FechaHora": logEntry.timestamp,
                        "Usuario": logEntry.user,
                        "Accion": logEntry.action,
                        "Dashboard": logEntry.dashboard || '',
                        "DashboardNombre": logEntry.dashboardName || '',
                        "Dispositivo": logEntry.deviceType,
                        "IP": logEntry.ip,
                        "UserAgent": logEntry.userAgent.substring(0, 300),
                        "SesionID": logEntry.sessionId,
                        "DetallesExtra": JSON.stringify(logEntry.extraData || {})
                    }
                };
                
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`;
                
                console.log('Enviando a Airtable:', airtableRecord.fields);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(airtableRecord)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Error Airtable:', response.status, errorText);
                    throw new Error(`Airtable error ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ Airtable response:', result);
                return result;
            }
            
            // Guardar en localStorage
            saveToLocalStorage(logEntry) {
                try {
                    const key = 'bi_logs_local';
                    let logs = JSON.parse(localStorage.getItem(key) || '[]');
                    logs.push(logEntry);
                    
                    if (logs.length > 1000) {
                        logs = logs.slice(-1000);
                    }
                    
                    localStorage.setItem(key, JSON.stringify(logs));
                } catch (error) {
                    console.error('Error guardando local:', error);
                }
            }
            
            // Guardar como pendiente
            saveAsPending(logEntry) {
                try {
                    const key = 'bi_logs_pending';
                    let pending = JSON.parse(localStorage.getItem(key) || '[]');
                    pending.push({ 
                        ...logEntry, 
                        retries: 0
                    });
                    
                    if (pending.length > 200) {
                        pending = pending.slice(-200);
                    }
                    
                    localStorage.setItem(key, JSON.stringify(pending));
                } catch (error) {
                    console.error('Error guardando pendiente:', error);
                }
            }
            
            // Guardar log urgente (para eventos cr√≠ticos como logout)
            saveUrgentLog(logEntry) {
                try {
                    // Guardar en localStorage inmediatamente
                    const key = 'bi_logs_urgent';
                    let urgent = JSON.parse(localStorage.getItem(key) || '[]');
                    urgent.push({ 
                        ...logEntry, 
                        timestamp: new Date().toISOString(),
                        storedAt: Date.now()
                    });
                    
                    if (urgent.length > 50) {
                        urgent = urgent.slice(-50);
                    }
                    
                    localStorage.setItem(key, JSON.stringify(urgent));
                    
                    // Tambi√©n guardar en pending para sincronizaci√≥n normal
                    this.saveAsPending(logEntry);
                    
                    console.log('üö® Log urgente guardado:', logEntry.action);
                } catch (error) {
                    console.error('Error guardando log urgente:', error);
                }
            }
            
            // Sincronizar pendientes
            async flushPendingLogs() {
                if (!this.isOnline) return;
                
                const pendingKey = 'bi_logs_pending';
                let pending = JSON.parse(localStorage.getItem(pendingKey) || '[]');
                
                if (pending.length === 0) return;
                
                console.log(`üîÑ Sincronizando ${pending.length} logs pendientes...`);
                
                const remaining = [];
                
                for (let i = 0; i < pending.length; i++) {
                    const logEntry = pending[i];
                    
                    try {
                        await this.sendToAirtable(logEntry);
                        console.log(`‚úÖ Pendiente ${i+1} enviado`);
                    } catch (error) {
                        logEntry.retries = (logEntry.retries || 0) + 1;
                        
                        if (logEntry.retries <= 3) {
                            remaining.push(logEntry);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                localStorage.setItem(pendingKey, JSON.stringify(remaining));
                console.log(`‚úÖ Sincronizados, ${remaining.length} a√∫n pendientes`);
            }
            
            loadPendingLogs() {
                try {
                    const pending = JSON.parse(localStorage.getItem('bi_logs_pending') || '[]');
                    console.log(`üì¶ ${pending.length} logs pendientes cargados`);
                } catch (error) {
                    console.error('Error cargando pendientes:', error);
                }
            }
            
            // Exportar logs locales
            exportLocalLogs() {
                try {
                    const localLogs = JSON.parse(localStorage.getItem('bi_logs_local') || '[]');
                    const pendingLogs = JSON.parse(localStorage.getItem('bi_logs_pending') || '[]');
                    
                    const allLogs = [...localLogs, ...pendingLogs];
                    
                    if (allLogs.length === 0) {
                        alert('No hay logs locales');
                        return;
                    }
                    
                    const headers = ['FechaHora', 'Usuario', 'Accion', 'Dashboard', 'DashboardNombre', 'Dispositivo', 'IP', 'SesionID', 'DetallesExtra'];
                    let csv = headers.join(';') + '\n';
                    
                    allLogs.forEach(log => {
                        const row = [
                            `"${log.timestamp}"`,
                            `"${log.user}"`,
                            `"${log.action}"`,
                            `"${log.dashboard || ''}"`,
                            `"${log.dashboardName || ''}"`,
                            `"${log.deviceType}"`,
                            `"${log.ip || ''}"`,
                            `"${log.sessionId}"`,
                            `"${JSON.stringify(log.extraData || {})}"`
                        ];
                        csv += row.join(';') + '\n';
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bi-logs-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`‚úÖ Exportados ${allLogs.length} logs`);
                    
                } catch (error) {
                    console.error('Error exportando:', error);
                    alert('‚ùå Error: ' + error.message);
                }
            }
            
            // Obtener estad√≠sticas
            getStats() {
                try {
                    const logs = JSON.parse(localStorage.getItem('bi_logs_local') || '[]');
                    const today = new Date().toDateString();
                    
                    const todayLogs = logs.filter(log => 
                        new Date(log.timestamp).toDateString() === today
                    );
                    
                    const uniqueUsers = [...new Set(todayLogs.map(log => log.user))];
                    const dispositivoDistribucion = todayLogs.reduce((acc, log) => {
                        acc[log.deviceType] = (acc[log.deviceType] || 0) + 1;
                        return acc;
                    }, {});
                    
                    return {
                        totalHoy: todayLogs.length,
                        usuariosUnicos: uniqueUsers.length,
                        dispositivoDistribucion: dispositivoDistribucion
                    };
                } catch (error) {
                    return { error: error.message };
                }
            }
            
            // Mostrar panel de estad√≠sticas
            showStatsPanel() {
                const stats = this.getStats();
                
                const statsHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #152c6e; color: white; padding: 15px; border-radius: 10px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 300px;">
                        <h3 style="margin-bottom: 10px; color: #FFD700;">üìä Estad√≠sticas Hoy</h3>
                        <p>üìà Total accesos: <strong>${stats.totalHoy || 0}</strong></p>
                        <p>üë• Usuarios √∫nicos: <strong>${stats.usuariosUnicos || 0}</strong></p>
                        <p>üì± Dispositivos:</p>
                        <ul style="margin-left: 20px;">
                            ${stats.dispositivoDistribucion ? 
                                Object.entries(stats.dispositivoDistribucion).map(([device, count]) => 
                                    `<li>${device}: ${count}</li>`
                                ).join('') : '<li>No hay datos</li>'}
                        </ul>
                        <button onclick="logger.exportLocalLogs()" style="margin-top: 10px; padding: 8px 15px; background: #FFD700; color: #152c6e; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                            üì• Exportar Logs
                        </button>
                        <button onclick="this.parentElement.remove()" style="margin-top: 5px; padding: 5px 10px; background: transparent; color: white; border: 1px solid white; border-radius: 5px; cursor: pointer; width: 100%;">
                            Cerrar
                        </button>
                    </div>
                `;
                
                const existingPanel = document.getElementById('statsPanel');
                if (existingPanel) existingPanel.remove();
                
                const panel = document.createElement('div');
                panel.id = 'statsPanel';
                panel.innerHTML = statsHTML;
                document.body.appendChild(panel);
            }
        }

        // Instancia global del logger
        const logger = new AirtableLogger();

        // Permisos por defecto
        const defaultPermissions = {
            "users": {
                "francisco.zamora@bigbola.com": {
                    "dashboards": ["principal", "adt", "bigplayers", "desempeno", "proyectos", "rtp", "diccionario"]
                },
                "gerente@bigbola.com": {
                    "dashboards": ["principal", "adt"]
                },
                "demo@bigbola.com": {
                    "dashboards": ["principal", "adt", "auditoria", "bigplayers", "desempeno"]
                }
            }
        };

        let permissionsData = null;
        let currentUser = null;
        let currentUserPermissions = [];

        // Detectar si es dispositivo m√≥vil/tableta
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || 
                   (navigator.userAgent.indexOf('IEMobile') !== -1) ||
                   (window.innerWidth <= 1024);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // üîí BLOQUEO DE SEGURIDAD EN LOGIN
            function blockRightClick(e) {
                e.preventDefault();
                showContextMenuMessage();
                return false;
            }
            
            function blockFunctionKeys(e) {
                // Teclas F1-F12
                if (e.keyCode >= 112 && e.keyCode <= 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+Shift+I (DevTools)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    return false;
                }
                
                // F12 (DevTools)
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+U (Ver c√≥digo fuente)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+Shift+C (Inspector)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+R (Recargar)
                if (e.ctrlKey && e.keyCode === 82) {
                    e.preventDefault();
                    return false;
                }
            }
            
            function showContextMenuMessage() {
                let message = document.getElementById('contextMenuMessageLogin');
                if (!message) {
                    message = document.createElement('div');
                    message.id = 'contextMenuMessageLogin';
                    message.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        padding: 10px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                        display: none;
                        animation: fadeInOut 3s ease-in-out;
                    `;
                    document.body.appendChild(message);
                    
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes fadeInOut {
                            0% { opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                message.textContent = 'Men√∫ contextual deshabilitado';
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            }
            
            function applyLoginSecurity() {
                document.addEventListener('contextmenu', blockRightClick);
                document.addEventListener('keydown', blockFunctionKeys);
            }
            
            // Aplicar seguridad inmediatamente
            applyLoginSecurity();
            
            // C√ìDIGO EXISTENTE
            showStatus('Cargando permisos...', 'loading');
            loadPermissions();
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.addEventListener('click', handleLogin);
            
            const emailInput = document.getElementById('email');
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // ‚≠ê SISTEMA MEJORADO PARA CAPTURAR LOGOUTS
            // Variable para rastrear sesiones activas
            let activeSessions = {};
            
            // Funci√≥n mejorada para procesar mensajes de logout
            function processLogoutMessage(eventData) {
                // Verificar si ya procesamos este logout recientemente
                const lastLogoutProcessed = sessionStorage.getItem('last_logout_processed');
                const now = Date.now();
                
                if (lastLogoutProcessed && (now - parseInt(lastLogoutProcessed)) < 1000) {
                    console.log('üîÑ Logout ya procesado recientemente, ignorando...');
                    return;
                }
                
                // Marcar como procesado
                sessionStorage.setItem('last_logout_processed', now.toString());
                
                console.log('üö™ Procesando logout:', eventData.user);
                
                // Registrar en Airtable
                logger.log('logout', null, eventData.user, { 
                    logoutType: eventData.logoutType || 'unknown',
                    sessionId: eventData.sessionId || 'unknown',
                    source: 'dashboard_message'
                });
                
                // Tambi√©n guardar como log urgente
                logger.saveUrgentLog({
                    timestamp: new Date().toISOString(),
                    user: eventData.user,
                    action: 'logout',
                    logoutType: eventData.logoutType || 'unknown',
                    sessionId: eventData.sessionId || 'unknown',
                    ip: userIP || 'unknown',
                    deviceType: 'desktop'
                });
                
                // Remover de sesiones activas
                if (eventData.user && activeSessions) {
                    delete activeSessions[eventData.user];
                }
                
                return true;
            }
            
            // Escuchar mensajes desde la ventana del dashboard (VERSI√ìN OPTIMIZADA)
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'logout') {
                    // Procesar logout con sistema mejorado (evita duplicados)
                    processLogoutMessage(event.data);
                }
                
                if (event.data && event.data.type === 'log_dashboard_view') {
                    // Registrar acceso desde la ventana del dashboard
                    logger.log('dashboard_view', event.data.dashboardKey, eventData.user);
                    console.log('üìä Log recibido desde dashboard:', event.data.dashboardKey);
                    
                    // Actualizar sesi√≥n activa
                    if (event.data.user) {
                        activeSessions[event.data.user] = {
                            lastActivity: Date.now(),
                            sessionId: event.data.sessionId || currentSessionId
                        };
                    }
                }
            });
            
            // Detectar sesiones hu√©rfanas (usuarios que cerraron sin logout)
            setInterval(() => {
                const now = Date.now();
                const timeout = 300000; // 5 minutos sin actividad
                
                Object.keys(activeSessions).forEach(user => {
                    const session = activeSessions[user];
                    if (now - session.lastActivity > timeout) {
                        console.log(`‚è∞ Sesi√≥n hu√©rfana detectada: ${user}`);
                        // Registrar logout por timeout
                        logger.log('logout', null, user, {
                            logoutType: 'session_timeout',
                            sessionId: session.sessionId,
                            timeoutReason: 'inactivity'
                        });
                        delete activeSessions[user];
                    }
                });
            }, 60000); // Verificar cada minuto
        });

        // Funci√≥n para cargar los permisos desde el JSON
        async function loadPermissions() {
            try {
                // Usar la ruta absoluta de GitHub Pages
                const jsonUrl = 'https://raw.githubusercontent.com/franciscozamoramx/centro-dashboards/refs/heads/main/PERMISSION_FILES_BI/permissions.json';
                
                console.log('Cargando permisos desde:', jsonUrl);
                
                const response = await fetch(jsonUrl + '?t=' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Respuesta recibida:', text);
                
                if (!text.trim()) {
                    throw new Error('El archivo JSON est√° vac√≠o');
                }
                
                const data = JSON.parse(text);
                
                if (!data.users) {
                    throw new Error('Estructura de JSON inv√°lida: falta propiedad "users"');
                }
                
                permissionsData = data;
                console.log('Permisos cargados correctamente desde GitHub Pages', permissionsData);
                showStatus('Permisos cargados correctamente', 'success');
                setTimeout(hideStatus, 2000);
                
            } catch (error) {
                console.error('Error al cargar permisos:', error);
                
                let errorMessage = 'Error cargando permisos: ' + error.message;
                
                permissionsData = defaultPermissions;
                showStatus('Usando permisos por defecto - ' + errorMessage, 'error');
                console.log('Permisos por defecto cargados:', permissionsData);
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            } else if (type === 'loading') {
                statusElement.classList.add('status-loading');
            }
            
            statusElement.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('email').value.trim().toLowerCase();
            
            if (!email) {
                showStatus('Por favor ingresa tu correo electr√≥nico', 'error');
                return;
            }
            
            if (!permissionsData) {
                showStatus('Error: Los permisos no se han cargado correctamente. Intenta nuevamente.', 'error');
                return;
            }
            
            if (permissionsData.users && permissionsData.users[email]) {
                currentUser = email;
                currentUserPermissions = permissionsData.users[email].dashboards || [];
                currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Registrar inicio de sesi√≥n
                logger.log('login', null, currentUser);
                
                // Mostrar informaci√≥n breve
                document.getElementById('userEmail').textContent = email;
                document.getElementById('dashboardsCount').textContent = currentUserPermissions.length;
                document.getElementById('userInfo').style.display = 'block';
                
                showStatus('Acceso concedido. Abriendo Centro de BI...', 'success');
                
                console.log('=== LOGIN EXITOSO ===');
                console.log('Usuario:', currentUser);
                console.log('Dashboards permitidos:', currentUserPermissions.length);
                console.log('Lista de dashboards:', currentUserPermissions);
                console.log('=====================');
                
                // Abrir directamente el dashboard despu√©s de breve delay
                setTimeout(() => {
                    openDashboard();
                }, 1000);
                
            } else {
                // Registrar intento fallido de login
                logger.log('login_failed', null, email);
                
                showStatus('No tienes permisos para acceder al Centro de BI o el correo no est√° registrado.', 'error');
            }
        }

        // Funci√≥n para abrir el dashboard en pantalla completa
        function openDashboard() {
            // Si es m√≥vil, mostrar versi√≥n m√≥vil en la misma ventana
            if (isMobileDevice()) {
                showMobileDashboard();
                return;
            }
            
            // Para PC: abrir en nueva ventana en pantalla completa
            const dashboardHTML = generateDashboardHTML();
            
            const dashboardWindow = window.open('', '_blank', 'width=' + screen.width + ',height=' + screen.height + ',left=0,top=0,fullscreen=yes');
            
            if (dashboardWindow) {
                dashboardWindow.document.write(dashboardHTML);
                dashboardWindow.document.close();
                dashboardWindow.focus();
                
                // Cerrar la ventana de login despu√©s de abrir el dashboard
                setTimeout(() => {
                    window.close();
                }, 1000);
                
            } else {
                // Si falla la ventana emergente, mostrar en la misma ventana
                showStatus('Popup bloqueado. Mostrando en esta ventana...', 'error');
                setTimeout(() => {
                    showMobileDashboard();
                }, 2000);
            }
        }

        // Funci√≥n para mostrar dashboard m√≥vil en la misma ventana
        function showMobileDashboard() {
            const mobileHTML = generateMobileDashboardHTML();
            document.body.innerHTML = mobileHTML;
            initMobileDashboardFunctionality();
        }

        // Funci√≥n para generar el HTML del dashboard m√≥vil
        function generateMobileDashboardHTML() {
            let menuItemsHTML = '';
            
            // Dashboard principal
            if (currentUserPermissions.includes('principal')) {
                menuItemsHTML += `
                    <button class="mobile-menu-item active" data-src="${dashboardUrls.principal}">
                        <i class="${dashboardIcons.principal}"></i> ${dashboardNames.principal}
                    </button>
                `;
            }
            
            // Otros dashboards
            const otherDashboards = currentUserPermissions.filter(d => d !== 'principal' && d !== 'diccionario');
            if (otherDashboards.length > 0) {
                menuItemsHTML += `<div class="mobile-menu-section">Dashboards</div>`;
                
                otherDashboards.forEach(dashboard => {
                    if (dashboardUrls[dashboard]) {
                        menuItemsHTML += `
                            <button class="mobile-menu-item" data-src="${dashboardUrls[dashboard]}">
                                <i class="${dashboardIcons[dashboard]}"></i> ${dashboardNames[dashboard]}
                            </button>
                        `;
                    }
                });
            }
            
            // Herramientas
            menuItemsHTML += `<div class="mobile-menu-section">Herramientas</div>`;
            
            // Diccionario KPI's
            if (currentUserPermissions.includes('diccionario')) {
                menuItemsHTML += `
                    <button class="mobile-menu-item" data-src="${dashboardUrls.diccionario}">
                        <i class="${dashboardIcons.diccionario}"></i> ${dashboardNames.diccionario}
                    </button>
                `;
            }
            
            // Bot√≥n de ayuda
            menuItemsHTML += `
                <button class="mobile-menu-item" id="mobileWhatsappBtn">
                    <i class="fab fa-whatsapp"></i> Ayuda
                </button>
            `;
            
            // Determinar dashboard inicial
            const firstDashboard = currentUserPermissions.includes('principal') ? 'principal' : currentUserPermissions[0];
            const initialUrl = dashboardUrls[firstDashboard] || dashboardUrls.principal;
            
            return `
                <div class="mobile-dashboard-container">
                    <button class="mobile-floating-toggle" id="mobileToggleBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="mobile-sidebar-overlay" id="mobileOverlay"></div>
                    
                    <div class="mobile-sidebar" id="mobileSidebar">
                        <div class="mobile-sidebar-header">
                            <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="mobile-sidebar-logo">
                            <div class="mobile-sidebar-title">
                                <div>Centro de</div>
                                <div>Business Intelligence</div>
                            </div>
                            <div class="user-info" style="margin-top: 10px; font-size: 12px;">
                                Usuario: ${currentUser}
                            </div>
                        </div>
                        ${menuItemsHTML}
                        <div class="mobile-sidebar-footer">
                            <button class="mobile-exit-btn" id="mobileExitBtn">
                                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                            </button>
                        </div>
                    </div>
                    
                    <div class="mobile-iframe-container" id="mobileIframeContainer">
                        <div class="iframe-loading" id="mobileIframeLoading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #152c6e; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                            <p>Cargando dashboard...</p>
                        </div>
                        <iframe class="mobile-iframe" id="mobileIframe" src="${initialUrl}"></iframe>
                    </div>
                </div>

                <style>
                    .mobile-dashboard-container {
                        width: 100vw;
                        height: 100vh;
                        background: #f5f5f5;
                        position: fixed;
                        top: 0;
                        left: 0;
                        z-index: 1000;
                    }
                    
                    .mobile-floating-toggle {
                        position: fixed;
                        top: 20px;
                        left: 20px;
                        width: 50px;
                        height: 50px;
                        background: rgba(26, 58, 143, 0.8);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        transition: all 0.3s ease;
                    }
                    
                    .mobile-sidebar {
                        position: fixed;
                        top: 0;
                        left: -280px;
                        width: 280px;
                        height: 100vh;
                        background: #152c6e;
                        z-index: 1002;
                        transition: left 0.3s ease;
                        overflow-y: auto;
                        padding: 20px;
                        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .mobile-sidebar.active { left: 0; }
                    
                    .mobile-sidebar-overlay {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 1001;
                    }
                    
                    .mobile-sidebar-overlay.active { display: block; }
                    
                    .mobile-sidebar-header {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 20px 0;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        margin-bottom: 20px;
                    }
                    
                    .mobile-sidebar-logo {
                        height: 60px;
                        width: auto;
                        margin-bottom: 15px;
                    }
                    
                    .mobile-sidebar-title {
                        font-size: 18px;
                        font-weight: bold;
                        color: white;
                        text-align: center;
                        line-height: 1.2;
                    }
                    
                    .mobile-menu-section {
                        color: #FFD700;
                        font-weight: bold;
                        margin: 20px 0 10px;
                        padding-bottom: 5px;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        font-size: 16px;
                    }
                    
                    .mobile-menu-item {
                        display: block;
                        width: 100%;
                        padding: 12px 15px;
                        margin-bottom: 8px;
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        text-align: left;
                        cursor: pointer;
                        transition: background 0.3s, transform 0.2s;
                        font-size: 15px;
                    }
                    
                    .mobile-menu-item:hover { 
                        background: rgba(255,255,255,0.2); 
                        transform: translateX(5px);
                    }
                    
                    .mobile-menu-item.active {
                        background: rgba(255,215,0,0.3);
                        border-left: 3px solid #FFD700;
                        font-weight: bold;
                    }
                    
                    .mobile-menu-item i {
                        margin-right: 10px;
                        width: 20px;
                        text-align: center;
                    }
                    
                    .mobile-sidebar-footer {
                        margin-top: auto;
                        padding-top: 20px;
                        border-top: 1px solid rgba(255,255,255,0.2);
                    }
                    
                    .mobile-exit-btn {
                        display: block;
                        width: 100%;
                        padding: 12px 15px;
                        background: rgba(255, 0, 0, 0.2);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 15px;
                        transition: background 0.3s;
                        text-align: center;
                    }
                    
                    .mobile-exit-btn:hover { background: rgba(255, 0, 0, 0.3); }
                    
                    .mobile-iframe-container {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: white;
                        transition: left 0.3s ease;
                    }
                    
                    .mobile-iframe-container.sidebar-open {
                        left: 280px;
                        width: calc(100% - 280px);
                    }
                    
                    .mobile-iframe {
                        width: 100%;
                        height: 100%;
                        border: none;
                        transition: opacity 0.3s;
                    }
                    
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    
                    @media (max-width: 600px) {
                        .mobile-floating-toggle {
                            width: 45px;
                            height: 45px;
                            font-size: 18px;
                            top: 15px;
                            left: 15px;
                        }
                        
                        .mobile-sidebar { width: 260px; }
                        
                        .mobile-iframe-container.sidebar-open {
                            left: 260px;
                            width: calc(100% - 260px);
                        }
                    }
                </style>
            `;
        }

        // Funci√≥n para inicializar funcionalidad del dashboard m√≥vil
        function initMobileDashboardFunctionality() {
            const mobileToggleBtn = document.getElementById('mobileToggleBtn');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const mobileIframeContainer = document.getElementById('mobileIframeContainer');
            const mobileIframe = document.getElementById('mobileIframe');
            const mobileIframeLoading = document.getElementById('mobileIframeLoading');
            const mobileMenuItems = document.querySelectorAll('.mobile-menu-item');
            const mobileWhatsappBtn = document.getElementById('mobileWhatsappBtn');
            const mobileExitBtn = document.getElementById('mobileExitBtn');
            
            let isSidebarOpen = false;
            window.mobileLogoutRegistered = false;
            
            // üîí Bloquear clic derecho SOLO en el men√∫ m√≥vil
            mobileSidebar.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // üö™ FUNCI√ìN MEJORADA PARA REGISTRAR LOGOUT M√ìVIL (EVITA DUPLICADOS)
            function registerMobileLogout(logoutType = 'button_click') {
                if (window.mobileLogoutRegistered) {
                    console.log('‚ö†Ô∏è Logout m√≥vil ya registrado, ignorando...');
                    return true;
                }
                
                try {
                    console.log('üö™ Registrando logout m√≥vil:', logoutType);
                    
                    // Marcar inmediatamente que ya se registr√≥ logout
                    window.mobileLogoutRegistered = true;
                    
                    const logoutData = {
                        user: currentUser,
                        action: 'logout',
                        logoutType: logoutType,
                        timestamp: new Date().toISOString(),
                        sessionId: currentSessionId,
                        deviceType: 'mobile',
                        registeredAt: Date.now()
                    };
                    
                    // Guardar en localStorage
                    localStorage.setItem('last_logout_mobile', JSON.stringify(logoutData));
                    
                    // Enviar al logger
                    logger.log('logout', null, currentUser, { 
                        logoutType: logoutType,
                        device: 'mobile'
                    });
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error registrando logout m√≥vil:', error);
                    return false;
                }
            }
            
            function openWhatsApp() {
                const phoneNumber = '+524421974414';
                const message = 'Hola, necesito ayuda en el Centro de Business Intelligence';
                const url = 'https://wa.me/' + phoneNumber + '?text=' + encodeURIComponent(message);
                window.open(url, '_blank');
            }
            
            function toggleSidebar() {
                isSidebarOpen = !isSidebarOpen;
                mobileSidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                mobileIframeContainer.classList.toggle('sidebar-open');
                
                if (isSidebarOpen) {
                    mobileToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    mobileToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                }
            }
            
            function loadMobileDashboard(dashboardUrl, dashboardKey) {
                // Mostrar loading
                mobileIframeLoading.style.display = 'block';
                mobileIframe.style.opacity = '0.3';
                
                // Registrar acceso
                logger.log('dashboard_view', dashboardKey, currentUser);
                
                // Cargar el dashboard
                mobileIframe.src = dashboardUrl;
                
                // Ocultar sidebar si est√° abierto
                if (isSidebarOpen) {
                    toggleSidebar();
                }
            }
            
            mobileToggleBtn.addEventListener('click', toggleSidebar);
            mobileOverlay.addEventListener('click', toggleSidebar);
            
            mobileMenuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const dashboardUrl = this.getAttribute('data-src');
                    
                    if (dashboardUrl) {
                        // Obtener qu√© dashboard se est√° accediendo
                        const dashboardKey = Object.keys(dashboardUrls).find(key => 
                            dashboardUrls[key] === dashboardUrl
                        );
                        
                        // Actualizar estado activo
                        mobileMenuItems.forEach(menuItem => {
                            menuItem.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Cargar dashboard
                        loadMobileDashboard(dashboardUrl, dashboardKey);
                    }
                });
            });
            
            mobileWhatsappBtn.addEventListener('click', function() {
                openWhatsApp();
            });
            
            // Bot√≥n de cerrar sesi√≥n (MEJORADO)
            mobileExitBtn.addEventListener('click', function() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    registerMobileLogout('button_click');
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            });
            
            // CAPTURAR CIERRE DE VENTANA M√ìVIL (MEJORADO)
            window.addEventListener('beforeunload', function(event) {
                // Solo registrar logout si no fue por el bot√≥n "Cerrar Sesi√≥n"
                if (!window.mobileLogoutRegistered) {
                    console.log('‚ö†Ô∏è Ventana m√≥vil cerrando, registrando logout...');
                    registerMobileLogout('window_close');
                }
            });
            
            // Evento cuando el iframe carga
            mobileIframe.addEventListener('load', function() {
                // Ocultar loading
                mobileIframeLoading.style.display = 'none';
                mobileIframe.style.opacity = '1';
            });
            
            // Manejar errores del iframe
            mobileIframe.addEventListener('error', function() {
                mobileIframeLoading.innerHTML = '<div style="color: #dc3545;"><i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 15px;"></i><p>Error al cargar el dashboard</p><button onclick="location.reload()" style="margin-top: 10px; padding: 8px 15px; background: #152c6e; color: white; border: none; border-radius: 4px; cursor: pointer;">Reintentar</button></div>';
            });
        }

        // Funci√≥n para generar el HTML del dashboard para PC
        function generateDashboardHTML() {
            let menuItemsHTML = '';
            
            if (currentUserPermissions.includes('principal')) {
                menuItemsHTML += `
                    <button class="menu-item active" data-src="${dashboardUrls.principal}">
                        <i class="${dashboardIcons.principal}"></i> ${dashboardNames.principal}
                    </button>
                `;
            }
            
            const otherDashboards = currentUserPermissions.filter(d => d !== 'principal' && d !== 'diccionario');
            if (otherDashboards.length > 0) {
                menuItemsHTML += `<div class="menu-section">Dashboards</div>`;
                
                otherDashboards.forEach(dashboard => {
                    if (dashboardUrls[dashboard]) {
                        menuItemsHTML += `
                            <button class="menu-item" data-src="${dashboardUrls[dashboard]}">
                                <i class="${dashboardIcons[dashboard]}"></i> ${dashboardNames[dashboard]}
                            </button>
                        `;
                    }
                });
            }
            
            menuItemsHTML += `<div class="menu-section">Herramientas</div>`;
            
            if (currentUserPermissions.includes('diccionario')) {
                menuItemsHTML += `
                    <button class="menu-item" data-src="${dashboardUrls.diccionario}">
                        <i class="${dashboardIcons.diccionario}"></i> ${dashboardNames.diccionario}
                    </button>
                `;
            }
            
            menuItemsHTML += `
                <button class="menu-item" id="whatsappBtn">
                    <i class="fab fa-whatsapp"></i> Ayuda
                </button>
            `;
            
            let initialDashboard = dashboardUrls.principal;
            if (currentUserPermissions.includes('principal')) {
                initialDashboard = dashboardUrls.principal;
            } else if (currentUserPermissions.length > 0) {
                initialDashboard = dashboardUrls[currentUserPermissions[0]] || dashboardUrls.principal;
            }
            
            // Convertir las constantes a JSON para pasarlas al dashboard
            const dashboardUrlsJson = JSON.stringify(dashboardUrls);
            const dashboardNamesJson = JSON.stringify(dashboardNames);
            const dashboardIconsJson = JSON.stringify(dashboardIcons);
            
            return `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Business Intelligence de Big Bola Casinos</title>
                    <link rel="icon" type="image/png" href="https://i.postimg.cc/QCN4dPG1/analisis-de-datos.png">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        }
                        
                        body {
                            background-color: #f5f5f5;
                            overflow: hidden;
                            margin: 0;
                            padding: 0;
                        }
                        
                        .container {
                            width: 100vw;
                            height: 100vh;
                            background-color: #fff;
                            display: flex;
                            flex-direction: column;
                            position: relative;
                        }
                        
                        .floating-toggle {
                            position: fixed;
                            top: 20px;
                            left: 20px;
                            width: 50px;
                            height: 50px;
                            background: rgba(26, 58, 143, 0.8);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            cursor: pointer;
                            z-index: 1001;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s ease;
                        }
                        
                        .floating-toggle:hover {
                            background: rgba(26, 58, 143, 0.9);
                            transform: scale(1.05);
                        }
                        
                        .sidebar {
                            position: fixed;
                            top: 0;
                            left: -320px;
                            width: 320px;
                            height: 100vh;
                            background: #152c6e;
                            z-index: 1002;
                            transition: left 0.3s ease;
                            overflow-y: auto;
                            padding: 20px;
                            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
                            display: flex;
                            flex-direction: column;
                        }
                        
                        .sidebar.active { left: 0; }
                        
                        .sidebar-overlay {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            z-index: 1001;
                        }
                        
                        .sidebar-overlay.active { display: block; }
                        
                        .sidebar-header {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            padding: 20px 0;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                            margin-bottom: 20px;
                        }
                        
                        .sidebar-logo {
                            height: 60px;
                            width: auto;
                            margin-bottom: 15px;
                        }
                        
                        .sidebar-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: white;
                            text-align: center;
                            line-height: 1.2;
                        }
                        
                        .user-info {
                            margin-top: 10px;
                            font-size: 12px;
                            color: #FFD700;
                            text-align: center;
                        }
                        
                        .menu-section {
                            color: #FFD700;
                            font-weight: bold;
                            margin: 20px 0 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                            font-size: 16px;
                        }
                        
                        .menu-item {
                            display: block;
                            width: 100%;
                            padding: 12px 15px;
                            margin-bottom: 8px;
                            background: rgba(255,255,255,0.1);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            text-align: left;
                            cursor: pointer;
                            transition: background 0.3s, transform 0.2s;
                            font-size: 15px;
                        }
                        
                        .menu-item:hover { 
                            background: rgba(255,255,255,0.2); 
                            transform: translateX(5px);
                        }
                        
                        .menu-item.active {
                            background: rgba(255,215,0,0.3);
                            border-left: 3px solid #FFD700;
                            font-weight: bold;
                        }
                        
                        .menu-item i {
                            margin-right: 10px;
                            width: 20px;
                            text-align: center;
                        }
                        
                        .sidebar-footer {
                            margin-top: auto;
                            padding-top: 20px;
                            border-top: 1px solid rgba(255,255,255,0.2);
                        }
                        
                        .exit-btn {
                            display: block;
                            width: 100%;
                            padding: 12px 15px;
                            background: rgba(255, 0, 0, 0.2);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 15px;
                            transition: background 0.3s;
                            text-align: center;
                        }
                        
                        .exit-btn:hover { background: rgba(255, 0, 0, 0.3); }
                        
                        .iframe-container {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: white;
                            transition: left 0.3s ease;
                        }
                        
                        .iframe-container.sidebar-open {
                            left: 320px;
                            width: calc(100% - 320px);
                        }
                        
                        iframe {
                            width: 100%;
                            height: 100%;
                            border: none;
                            transition: opacity 0.3s;
                        }
                        
                        /* Estilo para el mensaje de men√∫ deshabilitado */
                        .context-menu-message {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            background: rgba(0,0,0,0.7);
                            color: white;
                            padding: 10px;
                            border-radius: 5px;
                            z-index: 10000;
                            font-size: 14px;
                            display: none;
                            animation: fadeInOut 3s ease-in-out;
                        }
                        
                        @keyframes fadeInOut {
                            0% { opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { opacity: 0; }
                        }

                        /* Loading spinner para iframe */
                        .iframe-loading {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            text-align: center;
                            z-index: 100;
                        }

                        .spinner {
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #152c6e;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 15px;
                        }

                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </head>
                <body>
                    <div class="context-menu-message" id="contextMenuMessage">Men√∫ contextual deshabilitado</div>
                    <div class="container">
                        <button class="floating-toggle" id="toggleBtn">
                            <i class="fas fa-bars"></i>
                        </button>
                        
                        <div class="sidebar-overlay" id="overlay"></div>
                        
                        <div class="sidebar" id="sidebar">
                            <div class="sidebar-header">
                                <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="sidebar-logo">
                                <div class="sidebar-title">
                                    <div>Centro de</div>
                                    <div>Business Intelligence</div>
                                </div>
                                <div class="user-info">
                                    Usuario: ${currentUser}
                                </div>
                            </div>
                            ${menuItemsHTML}
                            <div class="sidebar-footer">
                                <button class="exit-btn" id="exitBtn">
                                    <i class="fas fa-sign-out-alt"></i> Salir
                                </button>
                            </div>
                        </div>
                        
                        <div class="iframe-container" id="iframeContainer">
                            <div class="iframe-loading" id="iframeLoading" style="display: none;">
                                <div class="spinner"></div>
                                <p>Cargando dashboard...</p>
                            </div>
                            <iframe id="dashboardFrame" src="${initialDashboard}"></iframe>
                        </div>
                    </div>

                    <script>
                        // üîß DECLARAR VARIABLES GLOBALES PARA ESTE SCRIPT
                        const dashboardUrls = ${dashboardUrlsJson};
                        const dashboardNames = ${dashboardNamesJson};
                        const dashboardIcons = ${dashboardIconsJson};
                        const currentUser = "${currentUser}";
                        const currentSessionId = "${currentSessionId}";
                        
                        // Variable global para controlar logout
                        window.logoutRegistered = false;
                        window.beaconSent = false;
                        
                        document.addEventListener('DOMContentLoaded', function() {
                            const toggleBtn = document.getElementById('toggleBtn');
                            const sidebar = document.getElementById('sidebar');
                            const overlay = document.getElementById('overlay');
                            const iframeContainer = document.getElementById('iframeContainer');
                            const menuItems = document.querySelectorAll('.menu-item');
                            const whatsappBtn = document.getElementById('whatsappBtn');
                            const exitBtn = document.getElementById('exitBtn');
                            const iframe = document.getElementById('dashboardFrame');
                            const iframeLoading = document.getElementById('iframeLoading');
                            const contextMenuMessage = document.getElementById('contextMenuMessage');
                            
                            let isSidebarOpen = false;
                            
                            // üîí FUNCIONES DE SEGURIDAD
                            function blockRightClickOnSidebar(e) {
                                e.preventDefault();
                                showContextMenuMessage();
                                return false;
                            }
                            
                            function showContextMenuMessage() {
                                contextMenuMessage.style.display = 'block';
                                setTimeout(() => {
                                    contextMenuMessage.style.display = 'none';
                                }, 3000);
                            }
                            
                            function applySecurityBlocks() {
                                sidebar.addEventListener('contextmenu', blockRightClickOnSidebar);
                            }
                            
                            // üìä ENVIAR LOG AL PADRE (login page)
                            function logDashboardAccess(dashboardKey) {
                                try {
                                    // Enviar mensaje al padre para logging
                                    if (window.opener && !window.opener.closed) {
                                        window.opener.postMessage({
                                            type: 'log_dashboard_view',
                                            dashboardKey: dashboardKey,
                                            user: currentUser,
                                            sessionId: currentSessionId,
                                            timestamp: new Date().toISOString()
                                        }, '*');
                                    }
                                    console.log('üìä Dashboard accedido:', dashboardKey);
                                } catch (error) {
                                    console.warn('Error en logging:', error);
                                }
                            }
                            
                            // üö™ FUNCI√ìN UNIFICADA PARA REGISTRAR LOGOUT (EVITA DUPLICADOS)
                            function registerLogout(logoutType = 'button_click') {
                                if (window.logoutRegistered) {
                                    console.log('‚ö†Ô∏è Logout ya registrado, ignorando...');
                                    return true;
                                }
                                
                                try {
                                    console.log('üö™ Registrando logout:', logoutType);
                                    
                                    // Marcar inmediatamente que ya se registr√≥ logout
                                    window.logoutRegistered = true;
                                    
                                    // 1. Crear datos de logout una sola vez
                                    const logoutData = {
                                        user: currentUser,
                                        action: 'logout',
                                        logoutType: logoutType,
                                        timestamp: new Date().toISOString(),
                                        sessionId: currentSessionId,
                                        deviceType: 'desktop',
                                        registeredAt: Date.now()
                                    };
                                    
                                    // 2. Guardar en localStorage (solo una vez)
                                    localStorage.setItem('last_logout', JSON.stringify(logoutData));
                                    
                                    // 3. A√±adir a logs pendientes (solo una vez)
                                    let pending = JSON.parse(localStorage.getItem('bi_logs_pending') || '[]');
                                    // Verificar si ya existe un logout similar
                                    const existingLogout = pending.find(log => 
                                        log.user === currentUser && 
                                        log.action === 'logout' && 
                                        (Date.now() - new Date(log.timestamp).getTime()) < 5000 // √öltimos 5 segundos
                                    );
                                    
                                    if (!existingLogout) {
                                        pending.push(logoutData);
                                        localStorage.setItem('bi_logs_pending', JSON.stringify(pending));
                                    }
                                    
                                    // 4. Enviar mensaje al padre (login page) - una sola vez
                                    if (window.opener && !window.opener.closed) {
                                        try {
                                            window.opener.postMessage({
                                                type: 'logout',
                                                ...logoutData,
                                                source: 'dashboard_window'
                                            }, '*');
                                            
                                            console.log('üì§ Mensaje de logout enviado al padre');
                                        } catch (error) {
                                            console.warn('Error enviando mensaje al padre:', error);
                                        }
                                    }
                                    
                                    // 5. Enviar con Beacon API (si est√° disponible)
                                    if (navigator.sendBeacon && !window.beaconSent) {
                                        try {
                                            const beaconData = new Blob(
                                                [JSON.stringify({
                                                    ...logoutData,
                                                    type: 'logout_beacon'
                                                })], 
                                                {type: 'application/json'}
                                            );
                                            
                                            window.beaconSent = true;
                                            const targetUrl = window.opener ? window.opener.location.href : window.location.href;
                                            navigator.sendBeacon(targetUrl, beaconData);
                                            console.log('üì° Beacon API enviado');
                                        } catch (beaconError) {
                                            console.warn('Beacon API fall√≥:', beaconError);
                                        }
                                    }
                                    
                                    console.log('‚úÖ Logout registrado exitosamente:', logoutType);
                                    return true;
                                    
                                } catch (error) {
                                    console.error('‚ùå Error registrando logout:', error);
                                    return false;
                                }
                            }
                            
                            // üì± FUNCIONES DE LA APLICACI√ìN
                            function openWhatsApp() {
                                const phoneNumber = '+524421974414';
                                const message = 'Hola, necesito ayuda en el Centro de Business Intelligence';
                                const url = 'https://wa.me/' + phoneNumber + '?text=' + encodeURIComponent(message);
                                window.open(url, '_blank');
                            }
                            
                            function toggleSidebar() {
                                isSidebarOpen = !isSidebarOpen;
                                sidebar.classList.toggle('active');
                                overlay.classList.toggle('active');
                                iframeContainer.classList.toggle('sidebar-open');
                                
                                toggleBtn.innerHTML = isSidebarOpen ? 
                                    '<i class="fas fa-times"></i>' : 
                                    '<i class="fas fa-bars"></i>';
                            }
                            
                            function loadDashboard(dashboardUrl, dashboardKey) {
                                // Mostrar loading
                                iframeLoading.style.display = 'block';
                                iframe.style.opacity = '0.3';
                                
                                // Registrar acceso
                                logDashboardAccess(dashboardKey);
                                
                                // Cargar el dashboard
                                iframe.src = dashboardUrl;
                                
                                // Ocultar sidebar si est√° abierto
                                if (isSidebarOpen) {
                                    toggleSidebar();
                                }
                            }
                            
                            function logout() {
                                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                                    // Registrar logout por bot√≥n
                                    const registered = registerLogout('button_click');
                                    
                                    if (registered) {
                                        // Cerrar despu√©s de un breve delay para permitir el logging
                                        setTimeout(() => {
                                            try {
                                                window.close();
                                            } catch (error) {
                                                console.warn('No se pudo cerrar ventana:', error);
                                            }
                                        }, 200);
                                    } else {
                                        alert('Error registrando logout. La ventana se cerrar√° de todos modos.');
                                        setTimeout(() => window.close(), 100);
                                    }
                                }
                            }
                            
                            // üéØ EVENT LISTENERS
                            toggleBtn.addEventListener('click', toggleSidebar);
                            overlay.addEventListener('click', toggleSidebar);
                            
                            menuItems.forEach(item => {
                                item.addEventListener('click', function() {
                                    const dashboardUrl = this.getAttribute('data-src');
                                    
                                    if (dashboardUrl) {
                                        // Encontrar la clave del dashboard
                                        const dashboardKey = Object.keys(dashboardUrls).find(key => 
                                            dashboardUrls[key] === dashboardUrl
                                        );
                                        
                                        // Actualizar estado activo
                                        menuItems.forEach(menuItem => {
                                            menuItem.classList.remove('active');
                                        });
                                        this.classList.add('active');
                                        
                                        // Cargar el dashboard
                                        loadDashboard(dashboardUrl, dashboardKey);
                                    }
                                });
                            });
                            
                            // Bot√≥n de WhatsApp
                            if (whatsappBtn) {
                                whatsappBtn.addEventListener('click', openWhatsApp);
                            }
                            
                            // Bot√≥n de salir
                            exitBtn.addEventListener('click', logout);
                            
                            // ‚≠ê CAPTURAR CIERRE DE VENTANA (VERSI√ìN MEJORADA)
                            window.addEventListener('beforeunload', function(event) {
                                // Solo registrar logout si NO fue por el bot√≥n "Salir"
                                if (!window.logoutRegistered) {
                                    console.log('‚ö†Ô∏è Ventana cerrando (beforeunload)');
                                    
                                    // Registrar logout por cierre de ventana
                                    registerLogout('window_close');
                                    
                                    // NO usar event.preventDefault() para evitar problemas de bloqueo
                                }
                            });
                            
                            // Evento cuando el iframe carga
                            iframe.addEventListener('load', function() {
                                // Ocultar loading
                                iframeLoading.style.display = 'none';
                                iframe.style.opacity = '1';
                            });
                            
                            // Manejar errores del iframe
                            iframe.addEventListener('error', function() {
                                iframeLoading.innerHTML = '<div style="color: #dc3545;"><i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 15px;"></i><p>Error al cargar el dashboard</p><button onclick="location.reload()" style="margin-top: 10px; padding: 8px 15px; background: #152c6e; color: white; border: none; border-radius: 4px; cursor: pointer;">Reintentar</button></div>';
                            });
                            
                            // üìã INICIALIZACI√ìN
                            applySecurityBlocks();
                            
                            // Pantalla completa
                            setTimeout(function() {
                                try {
                                    if (document.documentElement.requestFullscreen) {
                                        document.documentElement.requestFullscreen();
                                    }
                                } catch (err) {
                                    console.log('Pantalla completa no disponible:', err);
                                }
                            }, 100);
                            
                            // Verificar si hay logout pendiente de sesiones anteriores
                            setTimeout(() => {
                                try {
                                    const lastLogout = localStorage.getItem('last_logout');
                                    if (lastLogout) {
                                        const logoutData = JSON.parse(lastLogout);
                                        if (logoutData.user === currentUser && !window.logoutRegistered) {
                                            console.log('üîç Encontrado logout pendiente de sesi√≥n anterior');
                                            registerLogout('recovered_from_storage');
                                        }
                                    }
                                } catch (error) {
                                    console.warn('Error verificando logout pendiente:', error);
                                }
                            }, 2000);
                        });
                    <\/script>
                </body>
                </html>
            `;
        }
    </script>
</body>
</html>