<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BB Analytics 360 - Big Bola</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/PJSBFV7L/panel.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a3a8f 0%, #152c6e 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .logo {
            max-width: 250px;
            margin: 0 auto 20px;
            display: block;
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            color: white;
        }
        
        .title-highlight {
            color: #FFD700;
            font-weight: bold;
        }
        
        .version {
            font-size: 14px;
            color: #FFD700;
            font-weight: normal;
            vertical-align: super;
            margin-left: 5px;
            opacity: 0.8;
        }
        
        p {
            font-size: 18px;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(to bottom, #FFD700, #FF8C00);
            color: #152c6e;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, #FFE600, #FF9E00);
        }
        
        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }
        
        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .user-info {
            margin-top: 15px;
            font-size: 14px;
            color: #FFD700;
        }
        
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .status-success {
            background: rgba(0, 255, 0, 0.2);
            color: #90EE90;
        }
        
        .status-error {
            background: rgba(255, 0, 0, 0.2);
            color: #FFB6C1;
        }
        
        .status-loading {
            background: rgba(255, 255, 0, 0.2);
            color: #FFD700;
        }

        @media (max-width: 600px) {
            .login-container {
                padding: 25px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            p {
                font-size: 16px;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Contenedor de login -->
    <div class="login-container" id="loginContainer">
        <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="logo">
        <h1>BB <span class="title-highlight">Analytics 360</span><span class="version">V1.5</span></h1>
        <p>Ingresa con tu correo corporativo</p>
        
        <div class="login-form">
            <div class="form-group">
                <label for="email">Correo electrÃ³nico:</label>
                <input type="email" id="email" placeholder="usuario@bigbola.com" required>
            </div>
            <button class="btn" id="loginBtn">
                <i class="fas fa-sign-in-alt"></i> Ingresar a Analytics 360
            </button>
        </div>
        
        <div class="status-message" id="statusMessage" style="display: none;"></div>
        
        <div class="user-info" id="userInfo" style="display: none;">
            <p>Bienvenido: <span id="userEmail"></span></p>
            <p>Dashboards disponibles: <span id="dashboardsCount"></span></p>
        </div>
    </div>

    <script>
        // Mapeo de dashboards a URLs
        const dashboardUrls = {
            "principal": "", // Carrusel integrado
            "adt": "https://app.powerbi.com/reportEmbed?reportId=1149b379-aad5-4876-bfe6-c325dc89308f&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "auditoria": "https://app.powerbi.com/reportEmbed?reportId=23dbdb70-5e05-4e2f-9cf6-38a11489cd3e&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "bigplayers": "https://app.powerbi.com/reportEmbed?reportId=8e08098b-ce0e-46af-a8b5-e90b0b216e76&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "desempeno": "https://app.powerbi.com/reportEmbed?reportId=28c07103-a77e-42f4-a9ca-7d9345b48131&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "inventario": "https://app.powerbi.com/reportEmbed?reportId=4fe689c1-3fa7-4632-8367-4b7a7abc492c&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "promociones": "https://app.powerbi.com/reportEmbed?reportId=373b28bf-5d1b-46a0-b98b-4b3e378520c4&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "proyectos": "https://app.powerbi.com/reportEmbed?reportId=c2e5834e-4e3d-418c-a9dc-43e33d79a62e&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "rtp": "https://app.powerbi.com/reportEmbed?reportId=01ac285e-618f-43de-be89-d62b1a46374c&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "diccionario": "https://app.powerbi.com/reportEmbed?reportId=95918a25-c06b-411a-a346-f462b03e557b&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "seguimiento_auditores": "https://app.powerbi.com/reportEmbed?reportId=f298656f-f4fb-4110-9580-321f04c0cfd6&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "logs_bi": "https://app.powerbi.com/reportEmbed?reportId=36b35095-427f-4ded-82d4-27ce644ddeac&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c",
            "bolipoits": "https://app.powerbi.com/reportEmbed?reportId=74438490-c641-4240-930f-b55782ba7d39&autoAuth=true&ctid=b19d1a80-fff1-4a7e-b9ce-93f694e7b65c"
        };

        // Mapeo de nombres de dashboards
        const dashboardNames = {
            "principal": "Inicio",
            "adt": "ADT",
            "auditoria": "AuditorÃ­a de Salas",
            "bigplayers": "Big Player's",
            "desempeno": "DesempeÃ±o de MÃ¡quinas",
            "inventario": "Inventario TI",
            "promociones": "Promociones",
            "proyectos": "Proyectos BI",
            "rtp": "RTP",
            "diccionario": "Diccionario KPI's",
            "seguimiento_auditores": "Seguimiento de Auditores",
            "logs_bi": "Logs BB Analytics 360",
            "bolipoits": "Canje de Bolipoints"
        };

        // Mapeo de Ã­conos para dashboards
        const dashboardIcons = {
            "principal": "fas fa-images",
            "adt": "fas fa-chart-line",
            "auditoria": "fas fa-search",
            "bigplayers": "fas fa-gem",
            "desempeno": "fas fa-tachometer-alt",
            "inventario": "fas fa-desktop",
            "promociones": "fas fa-gift",
            "proyectos": "fas fa-project-diagram",
            "rtp": "fas fa-coins",
            "diccionario": "fas fa-book",
            "logs_bi": "fas fa-clipboard-list",
            "seguimiento_auditores": "fas fa-user-check",
            "bolipoits": "fas fa-ticket-alt"
        };

        // Mapeo de imÃ¡genes para el carrusel
        const dashboardImages = {
            "principal": "https://i.postimg.cc/nLbWqZYg/Intro-BB-Analytics-260.png",
            "adt": "https://i.postimg.cc/Xq3MYDhc/ADT.jpg",
            "auditoria": "https://i.postimg.cc/G2qk2tyB/Auditorias.png",
            "bigplayers": "https://i.postimg.cc/1tRC7ngP/BigPlayers.jpg",
            "desempeno": "https://i.postimg.cc/zGmWzXXF/DesempeÃ±o.png",
            "inventario": "https://i.postimg.cc/W1rHdPLR/Inventario.jpg",
            "promociones": "https://i.postimg.cc/q7TZnZ4N/Promociones.jpg",
            "proyectos": "https://i.postimg.cc/43Q21bxB/Proyectos.jpg",
            "rtp": "https://i.postimg.cc/rmhhBVW4/RTP.jpg",
            "diccionario": "https://i.postimg.cc/fy05qV9V/Diccionario.png",
            "seguimiento_auditores": "https://i.postimg.cc/W1cYKw8K/Seguimiento.png",
            "logs_bi": "https://i.postimg.cc/wM3nqxRV/Logs.png",
            "bolipoits": "https://i.postimg.cc/tJPwZSD2/Bolipoints.png"
        };

        // Mapeo de descripciones para el carrusel
        const dashboardDescriptions = {
            "principal": "Bienvenido a BB Analytics 360",
            "adt": "Average Daily Theoretical",
            "auditoria": "Control y seguimiento de auditorÃ­as",
            "bigplayers": "AnÃ¡lisis de promociones BigPlayer otorgadas",
            "desempeno": "Rendimiento de mÃ¡quinas",
            "inventario": "AnÃ¡lisis de equipos tecnolÃ³gicos",
            "promociones": "AnÃ¡lisis de campaÃ±as promocionales",
            "proyectos": "Seguimiento de proyectos de BI",
            "rtp": "Return to Player",
            "diccionario": "Definiciones y mÃ©tricas clave",
            "seguimiento_auditores": "Control de actividades de auditorÃ­a",
            "logs_bi": "Registro de accesos y actividad de BB Analytics 360",
            "bolipoits": "Analitica del sistema Big Club Reward"
        };

        // ==================== AIRTABLE LOGGER COMPLETO ====================
        const LOGGING_ENABLED = true;
        let currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        let userIP = null;

        // CONFIGURACIÃ“N AIRTABLE
        const AIRTABLE_CONFIG = {
            baseId: 'appyLYRPaDHgHRMfg',
            apiKey: 'patotjwpztoSwMBKc.19277efd2f0944e48d327235c5ecd969e1ece9b46543924225445a24d0992e23',
            tableName: 'Table 1'
        };

        class AirtableLogger {
            constructor() {
                this.pendingLogs = [];
                this.isOnline = navigator.onLine;
                
                // Obtener IP del usuario
                this.getUserIP();
                
                this.init();
            }
            
            async init() {
                // Detectar conexiÃ³n
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.flushPendingLogs();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });
                
                // Cargar pendientes
                this.loadPendingLogs();
                
                // Sincronizar cada 30 segundos
                setInterval(() => this.flushPendingLogs(), 30000);
                
                console.log('âœ… Logger Airtable inicializado');
            }
            
            // Obtener IP del usuario
            async getUserIP() {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    userIP = data.ip;
                    console.log('ðŸŒ IP obtenida:', userIP);
                } catch (error) {
                    console.warn('No se pudo obtener IP externa');
                    userIP = 'IP no disponible';
                }
            }
            
            // Detectar tipo de dispositivo
            detectDeviceType() {
                const userAgent = navigator.userAgent.toLowerCase();
                const screenWidth = window.screen.width;
                
                if (/mobile|android|iphone|ipad|ipod/.test(userAgent)) {
                    if (screenWidth >= 768) {
                        return 'tablet';
                    }
                    return 'mobile';
                }
                
                if (screenWidth >= 768 && screenWidth <= 1024) {
                    if (/android|ipad/.test(userAgent)) {
                        return 'tablet';
                    }
                }
                
                return 'desktop';
            }
            
            // Registrar evento
            async log(action, dashboard = null, user = null, extraData = {}) {
                const logEntry = {
                    id: 'log_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
                    timestamp: new Date().toISOString(),
                    fechaHoraLocal: new Date().toLocaleString('es-MX'),
                    user: user || currentUser || 'anonymous',
                    action: action,
                    dashboard: dashboard,
                    dashboardName: dashboard ? dashboardNames[dashboard] : null,
                    deviceType: this.detectDeviceType(),
                    screen: `${window.screen.width}x${window.screen.height}`,
                    userAgent: navigator.userAgent,
                    ip: userIP || 'Obteniendo...',
                    sessionId: currentSessionId,
                    extraData: extraData
                };
                
                console.log('ðŸ“ Registrando:', {
                    usuario: logEntry.user,
                    accion: logEntry.action,
                    dashboard: logEntry.dashboardName,
                    dispositivo: logEntry.deviceType,
                    ip: logEntry.ip,
                    extra: extraData
                });
                
                // 1. Guardar localmente
                this.saveToLocalStorage(logEntry);
                
                // 2. Intentar enviar a Airtable
                if (this.isOnline) {
                    try {
                        await this.sendToAirtable(logEntry);
                        console.log('âœ… Log enviado a Airtable');
                    } catch (error) {
                        console.warn('âš ï¸ Error Airtable, guardando pendiente:', error.message);
                        this.saveAsPending(logEntry);
                    }
                } else {
                    this.saveAsPending(logEntry);
                    console.log('ðŸ“¦ Log guardado como pendiente (offline)');
                }
                
                return logEntry;
            }
            
            // Enviar a Airtable - CON NOMBRES EXACTOS DE CAMPOS
            async sendToAirtable(logEntry) {
                const airtableRecord = {
                    fields: {
                        "FechaHora": logEntry.timestamp,
                        "Usuario": logEntry.user,
                        "Accion": logEntry.action,
                        "Dashboard": logEntry.dashboard || '',
                        "DashboardNombre": logEntry.dashboardName || '',
                        "Dispositivo": logEntry.deviceType,
                        "IP": logEntry.ip,
                        "UserAgent": logEntry.userAgent.substring(0, 300),
                        "SesionID": logEntry.sessionId
                    }
                };
                
                const url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.tableName}`;
                
                console.log('Enviando a Airtable:', airtableRecord.fields);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(airtableRecord)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Error Airtable:', response.status, errorText);
                    throw new Error(`Airtable error ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('âœ… Airtable response:', result);
                return result;
            }
            
            // Guardar en localStorage
            saveToLocalStorage(logEntry) {
                try {
                    const key = 'bi_logs_local';
                    let logs = JSON.parse(localStorage.getItem(key) || '[]');
                    logs.push(logEntry);
                    
                    if (logs.length > 1000) {
                        logs = logs.slice(-1000);
                    }
                    
                    localStorage.setItem(key, JSON.stringify(logs));
                } catch (error) {
                    console.error('Error guardando local:', error);
                }
            }
            
            // Guardar como pendiente
            saveAsPending(logEntry) {
                try {
                    const key = 'bi_logs_pending';
                    let pending = JSON.parse(localStorage.getItem(key) || '[]');
                    pending.push({ 
                        ...logEntry, 
                        retries: 0
                    });
                    
                    if (pending.length > 200) {
                        pending = pending.slice(-200);
                    }
                    
                    localStorage.setItem(key, JSON.stringify(pending));
                } catch (error) {
                    console.error('Error guardando pendiente:', error);
                }
            }
            
            // Sincronizar pendientes
            async flushPendingLogs() {
                if (!this.isOnline) return;
                
                const pendingKey = 'bi_logs_pending';
                let pending = JSON.parse(localStorage.getItem(pendingKey) || '[]');
                
                if (pending.length === 0) return;
                
                console.log(`ðŸ”„ Sincronizando ${pending.length} logs pendientes...`);
                
                const remaining = [];
                
                for (let i = 0; i < pending.length; i++) {
                    const logEntry = pending[i];
                    
                    try {
                        await this.sendToAirtable(logEntry);
                        console.log(`âœ… Pendiente ${i+1} enviado`);
                    } catch (error) {
                        logEntry.retries = (logEntry.retries || 0) + 1;
                        
                        if (logEntry.retries <= 3) {
                            remaining.push(logEntry);
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                localStorage.setItem(pendingKey, JSON.stringify(remaining));
                console.log(`âœ… Sincronizados, ${remaining.length} aÃºn pendientes`);
            }
            
            loadPendingLogs() {
                try {
                    const pending = JSON.parse(localStorage.getItem('bi_logs_pending') || '[]');
                    console.log(`ðŸ“¦ ${pending.length} logs pendientes cargados`);
                } catch (error) {
                    console.error('Error cargando pendientes:', error);
                }
            }
            
            // Exportar logs locales
            exportLocalLogs() {
                try {
                    const localLogs = JSON.parse(localStorage.getItem('bi_logs_local') || '[]');
                    const pendingLogs = JSON.parse(localStorage.getItem('bi_logs_pending') || '[]');
                    
                    const allLogs = [...localLogs, ...pendingLogs];
                    
                    if (allLogs.length === 0) {
                        alert('No hay logs locales');
                        return;
                    }
                    
                    const headers = ['FechaHora', 'Usuario', 'Accion', 'Dashboard', 'DashboardNombre', 'Dispositivo', 'IP', 'SesionID', 'UserAgent'];
                    let csv = headers.join(';') + '\n';
                    
                    allLogs.forEach(log => {
                        const row = [
                            `"${log.timestamp}"`,
                            `"${log.user}"`,
                            `"${log.action}"`,
                            `"${log.dashboard || ''}"`,
                            `"${log.dashboardName || ''}"`,
                            `"${log.deviceType}"`,
                            `"${log.ip || ''}"`,
                            `"${log.sessionId}"`,
                            `"${log.userAgent || ''}"`
                        ];
                        csv += row.join(';') + '\n';
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bb-analytics-logs-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    alert(`âœ… Exportados ${allLogs.length} logs de BB Analytics 360`);
                    
                } catch (error) {
                    console.error('Error exportando:', error);
                    alert('âŒ Error: ' + error.message);
                }
            }
            
            // Obtener estadÃ­sticas
            getStats() {
                try {
                    const logs = JSON.parse(localStorage.getItem('bi_logs_local') || '[]');
                    const today = new Date().toDateString();
                    
                    const todayLogs = logs.filter(log => 
                        new Date(log.timestamp).toDateString() === today
                    );
                    
                    const uniqueUsers = [...new Set(todayLogs.map(log => log.user))];
                    const dispositivoDistribucion = todayLogs.reduce((acc, log) => {
                        acc[log.deviceType] = (acc[log.deviceType] || 0) + 1;
                        return acc;
                    }, {});
                    
                    return {
                        totalHoy: todayLogs.length,
                        usuariosUnicos: uniqueUsers.length,
                        dispositivoDistribucion: dispositivoDistribucion
                    };
                } catch (error) {
                    return { error: error.message };
                }
            }
            
            // Mostrar panel de estadÃ­sticas
            showStatsPanel() {
                const stats = this.getStats();
                
                const statsHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #152c6e; color: white; padding: 15px; border-radius: 10px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 300px;">
                        <h3 style="margin-bottom: 10px; color: #FFD700;">ðŸ“Š BB Analytics 360 - Hoy</h3>
                        <p>ðŸ“ˆ Total accesos: <strong>${stats.totalHoy || 0}</strong></p>
                        <p>ðŸ‘¥ Usuarios Ãºnicos: <strong>${stats.usuariosUnicos || 0}</strong></p>
                        <p>ðŸ“± Dispositivos:</p>
                        <ul style="margin-left: 20px;">
                            ${stats.dispositivoDistribucion ? 
                                Object.entries(stats.dispositivoDistribucion).map(([device, count]) => 
                                    `<li>${device}: ${count}</li>`
                                ).join('') : '<li>No hay datos</li>'}
                        </ul>
                        <button onclick="logger.exportLocalLogs()" style="margin-top: 10px; padding: 8px 15px; background: #FFD700; color: #152c6e; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                            ðŸ“¥ Exportar Logs
                        </button>
                        <button onclick="this.parentElement.remove()" style="margin-top: 5px; padding: 5px 10px; background: transparent; color: white; border: 1px solid white; border-radius: 5px; cursor: pointer; width: 100%;">
                            Cerrar
                        </button>
                    </div>
                `;
                
                const existingPanel = document.getElementById('statsPanel');
                if (existingPanel) existingPanel.remove();
                
                const panel = document.createElement('div');
                panel.id = 'statsPanel';
                panel.innerHTML = statsHTML;
                document.body.appendChild(panel);
            }
        }

        // Instancia global del logger
        const logger = new AirtableLogger();

        // Permisos por defecto
        const defaultPermissions = {
            "users": {
                "francisco.zamora@bigbola.com": {
                    "dashboards": ["principal", "adt", "bigplayers", "desempeno", "proyectos", "rtp", "diccionario"]
                },
                "gerente@bigbola.com": {
                    "dashboards": ["principal", "adt"]
                },
                "demo@bigbola.com": {
                    "dashboards": ["principal", "adt", "auditoria", "bigplayers", "desempeno"]
                }
            }
        };

        let permissionsData = null;
        let currentUser = null;
        let currentUserPermissions = [];

        // Detectar si es dispositivo mÃ³vil/tableta
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || 
                   (navigator.userAgent.indexOf('IEMobile') !== -1) ||
                   (window.innerWidth <= 1024);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ðŸ”’ BLOQUEO DE SEGURIDAD EN LOGIN
            function blockRightClick(e) {
                e.preventDefault();
                showContextMenuMessage();
                return false;
            }
            
            function blockFunctionKeys(e) {
                // Teclas F1-F12
                if (e.keyCode >= 112 && e.keyCode <= 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+Shift+I (DevTools)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    return false;
                }
                
                // F12 (DevTools)
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+U (Ver cÃ³digo fuente)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+Shift+C (Inspector)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                    e.preventDefault();
                    return false;
                }
                
                // Ctrl+R (Recargar)
                if (e.ctrlKey && e.keyCode === 82) {
                    e.preventDefault();
                    return false;
                }
            }
            
            function showContextMenuMessage() {
                let message = document.getElementById('contextMenuMessageLogin');
                if (!message) {
                    message = document.createElement('div');
                    message.id = 'contextMenuMessageLogin';
                    message.style.cssText = `
                        position: fixed;
                        top: 10px;
                        right: 10px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        padding: 10px;
                        border-radius: 5px;
                        z-index: 10000;
                        font-size: 14px;
                        display: none;
                        animation: fadeInOut 3s ease-in-out;
                    `;
                    document.body.appendChild(message);
                    
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes fadeInOut {
                            0% { opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { opacity: 0; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                message.textContent = 'MenÃº contextual deshabilitado';
                message.style.display = 'block';
                setTimeout(() => {
                    message.style.display = 'none';
                }, 3000);
            }
            
            function applyLoginSecurity() {
                document.addEventListener('contextmenu', blockRightClick);
                document.addEventListener('keydown', blockFunctionKeys);
            }
            
            // Aplicar seguridad inmediatamente
            applyLoginSecurity();
            
            // CÃ“DIGO EXISTENTE
            showStatus('Cargando permisos...', 'loading');
            loadPermissions();
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.addEventListener('click', handleLogin);
            
            const emailInput = document.getElementById('email');
            emailInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // Escuchar mensajes desde la ventana del dashboard
            window.addEventListener('message', async function(event) {
                if (event.data && event.data.type === 'logout') {
                    console.log('ðŸšª Logout recibido desde dashboard:', event.data.user);
                    
                    // Registrar logout solo si viene del botÃ³n "Salir"
                    await logger.log('logout', null, event.data.user, { 
                        logoutType: event.data.logoutType || 'button_click',
                        sessionId: event.data.sessionId || 'unknown',
                        source: 'dashboard_button'
                    });
                }
                
                if (event.data && event.data.type === 'log_dashboard_view') {
                    // Registrar acceso desde la ventana del dashboard
                    await logger.log('dashboard_view', event.data.dashboardKey, event.data.user);
                    console.log('ðŸ“Š Log recibido desde dashboard:', event.data.dashboardKey);
                }
                
                if (event.data && event.data.type === 'dashboard_access') {
                    // Registrar acceso a dashboard desde carrusel
                    await logger.log('dashboard_view', event.data.dashboardKey, event.data.user, {
                        source: 'carrusel_click',
                        timestamp: event.data.timestamp
                    });
                    console.log('ðŸ“Š Dashboard accedido desde carrusel:', event.data.dashboardKey);
                }
            });
        });

        // FunciÃ³n para cargar los permisos desde el JSON
        async function loadPermissions() {
            try {
                // Usar la ruta absoluta de GitHub Pages
                const jsonUrl = 'https://raw.githubusercontent.com/franciscozamoramx/bbanalytics360/refs/heads/main/PERMISSION_FILES_BI/permissions.json';
                
                console.log('Cargando permisos desde:', jsonUrl);
                
                const response = await fetch(jsonUrl + '?t=' + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Respuesta recibida:', text);
                
                if (!text.trim()) {
                    throw new Error('El archivo JSON estÃ¡ vacÃ­o');
                }
                
                const data = JSON.parse(text);
                
                if (!data.users) {
                    throw new Error('Estructura de JSON invÃ¡lida: falta propiedad "users"');
                }
                
                permissionsData = data;
                console.log('Permisos cargados correctamente desde GitHub Pages', permissionsData);
                showStatus('Permisos cargados correctamente', 'success');
                setTimeout(hideStatus, 2000);
                
            } catch (error) {
                console.error('Error al cargar permisos:', error);
                
                let errorMessage = 'Error cargando permisos: ' + error.message;
                
                permissionsData = defaultPermissions;
                showStatus('Usando permisos por defecto - ' + errorMessage, 'error');
                console.log('Permisos por defecto cargados:', permissionsData);
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = 'status-message';
            
            if (type === 'success') {
                statusElement.classList.add('status-success');
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
            } else if (type === 'loading') {
                statusElement.classList.add('status-loading');
            }
            
            statusElement.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('email').value.trim().toLowerCase();
            
            if (!email) {
                showStatus('Por favor ingresa tu correo electrÃ³nico', 'error');
                return;
            }
            
            if (!permissionsData) {
                showStatus('Error: Los permisos no se han cargado correctamente. Intenta nuevamente.', 'error');
                return;
            }
            
            if (permissionsData.users && permissionsData.users[email]) {
                currentUser = email;
                currentUserPermissions = permissionsData.users[email].dashboards || [];
                currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Registrar inicio de sesiÃ³n
                await logger.log('login', null, currentUser);
                
                // Mostrar informaciÃ³n breve
                document.getElementById('userEmail').textContent = email;
                document.getElementById('dashboardsCount').textContent = currentUserPermissions.length;
                document.getElementById('userInfo').style.display = 'block';
                
                showStatus('Acceso concedido. Abriendo BB Analytics 360...', 'success');
                
                console.log('=== LOGIN EXITOSO ===');
                console.log('Usuario:', currentUser);
                console.log('Dashboards permitidos:', currentUserPermissions.length);
                console.log('Lista de dashboards:', currentUserPermissions);
                console.log('Session ID:', currentSessionId);
                console.log('=====================');
                
                // Abrir directamente el dashboard despuÃ©s de breve delay
                setTimeout(() => {
                    openDashboard();
                }, 1000);
                
            } else {
                // Registrar intento fallido de login
                await logger.log('login_failed', null, email);
                
                showStatus('No tienes permisos para acceder a BB Analytics 360 o el correo no estÃ¡ registrado.', 'error');
            }
        }

        // FunciÃ³n para abrir el dashboard en pantalla completa
        function openDashboard() {
            // Si es mÃ³vil, mostrar versiÃ³n mÃ³vil en la misma ventana
            if (isMobileDevice()) {
                showMobileDashboard();
                return;
            }
            
            // Para PC: abrir en nueva ventana en pantalla completa
            const dashboardHTML = generateDashboardHTML();
            
            const dashboardWindow = window.open('', '_blank', 'width=' + screen.width + ',height=' + screen.height + ',left=0,top=0,fullscreen=yes');
            
            if (dashboardWindow) {
                dashboardWindow.document.write(dashboardHTML);
                dashboardWindow.document.close();
                dashboardWindow.focus();
                
                // Cerrar la ventana de login despuÃ©s de abrir el dashboard
                setTimeout(() => {
                    window.close();
                }, 1000);
                
            } else {
                // Si falla la ventana emergente, mostrar en la misma ventana
                showStatus('Popup bloqueado. Mostrando en esta ventana...', 'error');
                setTimeout(() => {
                    showMobileDashboard();
                }, 2000);
            }
        }

        // FunciÃ³n para mostrar dashboard mÃ³vil en la misma ventana
        function showMobileDashboard() {
            const mobileHTML = generateMobileDashboardHTML();
            document.body.innerHTML = mobileHTML;
            initMobileDashboardFunctionality();
        }

        // FunciÃ³n para generar el HTML del dashboard mÃ³vil
        function generateMobileDashboardHTML() {
            let menuItemsHTML = '';
            
            // Dashboard principal (carrusel integrado)
            if (currentUserPermissions.includes('principal')) {
                menuItemsHTML += `
                    <button class="mobile-menu-item active" data-src="carrusel_integrado">
                        <i class="${dashboardIcons.principal}"></i> ${dashboardNames.principal}
                    </button>
                `;
            }
            
            // Otros dashboards
            const otherDashboards = currentUserPermissions.filter(d => d !== 'principal' && d !== 'diccionario');
            if (otherDashboards.length > 0) {
                menuItemsHTML += `<div class="mobile-menu-section">Dashboards</div>`;
                
                otherDashboards.forEach(dashboard => {
                    if (dashboardUrls[dashboard]) {
                        menuItemsHTML += `
                            <button class="mobile-menu-item" data-src="${dashboardUrls[dashboard]}">
                                <i class="${dashboardIcons[dashboard]}"></i> ${dashboardNames[dashboard]}
                            </button>
                        `;
                    }
                });
            }
            
            // Herramientas
            menuItemsHTML += `<div class="mobile-menu-section">Herramientas</div>`;
            
            // Diccionario KPI's
            if (currentUserPermissions.includes('diccionario')) {
                menuItemsHTML += `
                    <button class="mobile-menu-item" data-src="${dashboardUrls.diccionario}">
                        <i class="${dashboardIcons.diccionario}"></i> ${dashboardNames.diccionario}
                    </button>
                `;
            }
            
            // BotÃ³n de ayuda
            menuItemsHTML += `
                <button class="mobile-menu-item" id="mobileWhatsappBtn">
                    <i class="fab fa-whatsapp"></i> Ayuda
                </button>
            `;
            
            return `
                <div class="mobile-dashboard-container">
                    <button class="mobile-floating-toggle" id="mobileToggleBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="mobile-sidebar-overlay" id="mobileOverlay"></div>
                    
                    <div class="mobile-sidebar" id="mobileSidebar">
                        <div class="mobile-sidebar-header">
                            <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="mobile-sidebar-logo">
                            <div class="mobile-sidebar-title">
                                <div>BB Analytics 360 <span style="font-size: 12px; color: #FFD700; margin-left: 5px;">V1.5</span></div>
                                <div style="font-size: 14px; margin-top: 5px;">Plataforma de Business Intelligence</div>
                            </div>
                            <div class="user-info" style="margin-top: 10px; font-size: 12px;">
                                Usuario: ${currentUser}<br>
                                Dashboards: ${currentUserPermissions.length} disponibles
                            </div>
                        </div>
                        ${menuItemsHTML}
                        <div class="mobile-sidebar-footer">
                            <button class="mobile-exit-btn" id="mobileExitBtn">
                                <i class="fas fa-sign-out-alt"></i> Cerrar SesiÃ³n
                            </button>
                        </div>
                    </div>
                    
                    <div class="mobile-iframe-container" id="mobileIframeContainer">
                        <div class="iframe-loading" id="mobileIframeLoading" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #152c6e; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                            <p>Cargando dashboard...</p>
                        </div>
                        <div id="mobileContentContainer" class="carrusel-container">
                            ${generateCarruselHTML()}
                        </div>
                    </div>
                </div>

                <style>
                    .mobile-dashboard-container {
                        width: 100vw;
                        height: 100vh;
                        background: #f5f5f5;
                        position: fixed;
                        top: 0;
                        left: 0;
                        z-index: 1000;
                    }
                    
                    .mobile-floating-toggle {
                        position: fixed;
                        top: 20px;
                        left: 20px;
                        width: 50px;
                        height: 50px;
                        background: rgba(26, 58, 143, 0.8);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        cursor: pointer;
                        z-index: 1001;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        transition: all 0.3s ease;
                    }
                    
                    .mobile-sidebar {
                        position: fixed;
                        top: 0;
                        left: -280px;
                        width: 280px;
                        height: 100vh;
                        background: #152c6e;
                        z-index: 1002;
                        transition: left 0.3s ease;
                        overflow-y: auto;
                        padding: 20px;
                        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
                        display: flex;
                        flex-direction: column;
                    }
                    
                    .mobile-sidebar.active { left: 0; }
                    
                    .mobile-sidebar-overlay {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        z-index: 1001;
                    }
                    
                    .mobile-sidebar-overlay.active { display: block; }
                    
                    .mobile-sidebar-header {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 20px 0;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        margin-bottom: 20px;
                    }
                    
                    .mobile-sidebar-logo {
                        height: 60px;
                        width: auto;
                        margin-bottom: 15px;
                    }
                    
                    .mobile-sidebar-title {
                        font-size: 18px;
                        font-weight: bold;
                        color: white;
                        text-align: center;
                        line-height: 1.2;
                    }
                    
                    .mobile-menu-section {
                        color: #FFD700;
                        font-weight: bold;
                        margin: 20px 0 10px;
                        padding-bottom: 5px;
                        border-bottom: 1px solid rgba(255,255,255,0.2);
                        font-size: 16px;
                    }
                    
                    .mobile-menu-item {
                        display: block;
                        width: 100%;
                        padding: 12px 15px;
                        margin-bottom: 8px;
                        background: rgba(255,255,255,0.1);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        text-align: left;
                        cursor: pointer;
                        transition: background 0.3s, transform 0.2s;
                        font-size: 15px;
                    }
                    
                    .mobile-menu-item:hover { 
                        background: rgba(255,255,255,0.2); 
                        transform: translateX(5px);
                    }
                    
                    .mobile-menu-item.active {
                        background: rgba(255,215,0,0.3);
                        border-left: 3px solid #FFD700;
                        font-weight: bold;
                    }
                    
                    .mobile-menu-item i {
                        margin-right: 10px;
                        width: 20px;
                        text-align: center;
                    }
                    
                    .mobile-sidebar-footer {
                        margin-top: auto;
                        padding-top: 20px;
                        border-top: 1px solid rgba(255,255,255,0.2);
                    }
                    
                    .mobile-exit-btn {
                        display: block;
                        width: 100%;
                        padding: 12px 15px;
                        background: rgba(255, 0, 0, 0.2);
                        color: white;
                        border: none;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 15px;
                        transition: background 0.3s;
                        text-align: center;
                    }
                    
                    .mobile-exit-btn:hover { background: rgba(255, 0, 0, 0.3); }
                    
                    .mobile-iframe-container {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: white;
                        transition: left 0.3s ease;
                    }
                    
                    .mobile-iframe-container.sidebar-open {
                        left: 280px;
                        width: calc(100% - 280px);
                    }
                    
                    .mobile-iframe {
                        width: 100%;
                        height: 100%;
                        border: none;
                        transition: opacity 0.3s;
                    }
                    
                    /* Estilos para carrusel mÃ³vil */
                    .carrusel-container {
                        width: 100%;
                        height: 100%;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        background: linear-gradient(135deg, #1a3a8f 0%, #152c6e 100%);
                        overflow: hidden;
                        padding: 20px;
                    }
                    
                    .carrusel-title {
                        color: white;
                        font-size: 24px;
                        margin-bottom: 20px;
                        text-align: center;
                        padding: 0 10px;
                    }
                    
                    .carrusel-title span {
                        color: #FFD700;
                        font-weight: bold;
                    }
                    
                    .carrusel-permission-info {
                        color: #FFD700;
                        font-size: 14px;
                        margin-bottom: 20px;
                        text-align: center;
                    }
                    
                    .carrusel-slider {
                        width: 100%;
                        height: 60vh;
                        position: relative;
                        overflow: hidden;
                        border-radius: 15px;
                        background: transparent;
                    }
                    
                    .carrusel-slide {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        opacity: 0;
                        transition: opacity 0.8s ease-in-out;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                        background-color: transparent;
                        padding: 20px;
                        text-align: center;
                    }
                    
                    .carrusel-slide.active {
                        opacity: 1;
                    }
                    
                    .carrusel-slide img {
                        max-width: 60%;
                        max-height: 50%;
                        object-fit: contain;
                        border-radius: 10px;
                        margin-bottom: 15px;
                        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                        cursor: pointer;
                        transition: transform 0.3s ease;
                        z-index: 10;
                        position: relative;
                    }

                    .carrusel-slide img:hover {
                        transform: scale(1.02);
                    }
                    
                    .carrusel-slide h3 {
                        color: white;
                        font-size: 20px;
                        margin-bottom: 10px;
                        font-weight: bold;
                        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
                    }
                    
                    .carrusel-slide p {
                        color: #FFD700;
                        font-size: 14px;
                        line-height: 1.4;
                        max-width: 100%;
                        margin: 0 auto 15px;
                        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
                    }
                    
                    .carrusel-slide .dashboard-title {
                        color: white;
                        font-size: 18px;
                        margin-bottom: 8px;
                        font-weight: bold;
                    }
                    
                    .carrusel-slide .dashboard-desc {
                        color: #FFD700;
                        font-size: 12px;
                        margin-bottom: 10px;
                    }
                    
                    .carrusel-indicators {
                        display: flex;
                        justify-content: center;
                        gap: 10px;
                        margin-top: 20px;
                        position: absolute;
                        bottom: 15px;
                        left: 0;
                        right: 0;
                    }
                    
                    .carrusel-indicator {
                        width: 10px;
                        height: 10px;
                        background-color: rgba(255, 255, 255, 0.4);
                        border-radius: 50%;
                        cursor: pointer;
                        transition: background-color 0.3s, transform 0.3s;
                    }
                    
                    .carrusel-indicator.active {
                        background-color: #FFD700;
                        transform: scale(1.3);
                    }
                    
                    .carrusel-nav {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        background-color: rgba(21, 44, 110, 0.8);
                        color: white;
                        border: none;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        font-size: 18px;
                        z-index: 10;
                        transition: background-color 0.3s;
                    }
                    
                    .carrusel-nav:hover {
                        background-color: rgba(21, 44, 110, 1);
                    }
                    
                    .carrusel-prev {
                        left: 10px;
                    }
                    
                    .carrusel-next {
                        right: 10px;
                    }
                    
                    .carrusel-slide-description {
                        font-style: italic;
                        color: #FFD700;
                        margin-top: 8px;
                        font-size: 12px;
                    }
                    
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    
                    @media (max-width: 600px) {
                        .mobile-floating-toggle {
                            width: 45px;
                            height: 45px;
                            font-size: 18px;
                            top: 15px;
                            left: 15px;
                        }
                        
                        .mobile-sidebar { width: 260px; }
                        
                        .mobile-iframe-container.sidebar-open {
                            left: 260px;
                            width: calc(100% - 260px);
                        }
                        
                        .carrusel-title {
                            font-size: 20px;
                        }
                        
                        .carrusel-slider {
                            height: 55vh;
                        }
                        
                        .carrusel-slide h3 {
                            font-size: 18px;
                        }
                        
                        .carrusel-slide p {
                            font-size: 13px;
                        }
                    }
                    
                    @media (max-width: 400px) {
                        .carrusel-slider {
                            height: 50vh;
                        }
                        
                        .carrusel-title {
                            font-size: 18px;
                        }
                        
                        .carrusel-slide h3 {
                            font-size: 16px;
                        }
                        
                        .carrusel-slide p {
                            font-size: 12px;
                        }
                    }
                </style>
            `;
        }

        // ðŸ”§ FUNCIÃ“N AUXILIAR PARA GENERAR HTML DEL CARRUSEL
        function generateCarruselHTML() {
            return `
                <h1 class="carrusel-title"> <span> BB Analytics 360 </span> <span style="font-size: 16px; color: #FFD700; font-weight: normal; margin-left: 5px;">V1.5</span> </h1>
                <div class="carrusel-permission-info" id="carruselPermissionInfo">
                    <i class="fas fa-user-check"></i> Cargando informaciÃ³n de usuario...
                </div>
                <div class="carrusel-slider" id="carruselSlider">
                    <div style="text-align: center; padding: 40px; color: white;">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <p>Cargando carrusel de dashboards...</p>
                    </div>
                </div>
            `;
        }

        // FunciÃ³n para inicializar funcionalidad del dashboard mÃ³vil
        function initMobileDashboardFunctionality() {
            const mobileToggleBtn = document.getElementById('mobileToggleBtn');
            const mobileSidebar = document.getElementById('mobileSidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const mobileIframeContainer = document.getElementById('mobileIframeContainer');
            const mobileIframeLoading = document.getElementById('mobileIframeLoading');
            const mobileMenuItems = document.querySelectorAll('.mobile-menu-item');
            const mobileWhatsappBtn = document.getElementById('mobileWhatsappBtn');
            const mobileExitBtn = document.getElementById('mobileExitBtn');
            const mobileContentContainer = document.getElementById('mobileContentContainer');
            
            let isSidebarOpen = false;
            let currentMobileSlide = 0;
            let mobileCarruselData = [];
            let mobileAutoPlayInterval;
            let mobileIsAutoPlay = true;
            
            // ðŸ”§ FUNCIÃ“N PARA GENERAR DATOS DEL CARRUSEL MÃ“VIL
            function generateMobileCarruselData() {
                const data = [];
                
                currentUserPermissions.forEach(dashboardKey => {
                    if (dashboardKey !== 'diccionario' && dashboardUrls[dashboardKey]) {
                        const imageUrl = dashboardImages[dashboardKey] || 'https://i.postimg.cc/QCN4dPG1/analisis-de-datos.png';
                        const description = dashboardDescriptions[dashboardKey] || 'Dashboard de Business Intelligence';
                        
                        data.push({
                            key: dashboardKey,
                            title: dashboardNames[dashboardKey],
                            image: imageUrl,
                            description: description,
                            icon: dashboardIcons[dashboardKey],
                            url: dashboardUrls[dashboardKey]
                        });
                    }
                });
                
                return data;
            }
            
            // ðŸ”§ INICIALIZAR CARRUSEL MÃ“VIL
            function initMobileCarrusel() {
                mobileCarruselData = generateMobileCarruselData();
                
                if (mobileCarruselData.length === 0) {
                    mobileContentContainer.innerHTML = `
                        <div style="text-align: center; color: white; padding: 30px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 50px; margin-bottom: 15px; color: #FFD700;"></i>
                            <h2 style="font-size: 22px; margin-bottom: 10px;">No hay dashboards disponibles</h2>
                            <p style="font-size: 16px;">No tienes permisos para acceder a ningÃºn dashboard.</p>
                            <p style="font-size: 14px; margin-top: 15px; color: #FFD700;">
                                Contacta al administrador para solicitar acceso.
                            </p>
                        </div>
                    `;
                    return;
                }
                
                const slidesHTML = mobileCarruselData.map((slide, index) => `
                    <div class="carrusel-slide ${index === 0 ? 'active' : ''}" data-index="${index}">
                        <img src="${slide.image}" alt="${slide.title}" data-key="${slide.key}">
                        <div class="dashboard-title">${slide.title}</div>
                        <div class="dashboard-desc">${slide.description}</div>
                        <p class="carrusel-slide-description">
                            Toca la imagen para acceder al dashboard
                        </p>
                    </div>
                `).join('');
                
                const indicatorsHTML = mobileCarruselData.map((_, index) => `
                    <div class="carrusel-indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></div>
                `).join('');
                
                mobileContentContainer.innerHTML = `
                    <h1 class="carrusel-title">BB <span>Analytics 360</span> <span style="font-size: 14px; color: #FFD700; font-weight: normal; margin-left: 5px;">V1.5</span></h1>
                    <div class="carrusel-permission-info">
                        <i class="fas fa-user-check"></i> ${currentUser} | 
                        <i class="fas fa-chart-bar"></i> ${mobileCarruselData.length} dashboards
                    </div>
                    <div class="carrusel-slider">
                        <button class="carrusel-nav carrusel-prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="carrusel-nav carrusel-next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        ${slidesHTML}
                        <div class="carrusel-indicators">
                            ${indicatorsHTML}
                        </div>
                    </div>
                `;
                
                setupMobileCarruselEvents();
                startMobileAutoPlay();
            }
            
            // ðŸ”§ CONFIGURAR EVENTOS DEL CARRUSEL MÃ“VIL
            function setupMobileCarruselEvents() {
                const prevBtn = document.querySelector('.carrusel-prev');
                const nextBtn = document.querySelector('.carrusel-next');
                const indicators = document.querySelectorAll('.carrusel-indicator');
                const slideImages = document.querySelectorAll('.carrusel-slide img');
                
                if (prevBtn) prevBtn.addEventListener('click', showMobilePrevSlide);
                if (nextBtn) nextBtn.addEventListener('click', showMobileNextSlide);
                
                indicators.forEach(indicator => {
                    indicator.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        goToMobileSlide(index);
                    });
                });
                
                slideImages.forEach(img => {
                    img.addEventListener('click', async function() {
                        const dashboardKey = this.getAttribute('data-key');
                        if (dashboardKey && dashboardUrls[dashboardKey]) {
                            // âœ… REGISTRAR ACCESO AL DASHBOARD EN AIRTABLE
                            await logger.log('dashboard_view', dashboardKey, currentUser, {
                                source: 'mobile_carrusel_click',
                                timestamp: new Date().toISOString()
                            });
                            
                            // Cargar el dashboard
                            loadMobileDashboard(dashboardUrls[dashboardKey], dashboardKey);
                        }
                    });
                });
            }
            
            // ðŸ”§ FUNCIONES DE CONTROL DEL CARRUSEL MÃ“VIL
            function showMobileNextSlide() {
                currentMobileSlide = (currentMobileSlide + 1) % mobileCarruselData.length;
                updateMobileCarrusel();
            }
            
            function showMobilePrevSlide() {
                currentMobileSlide = (currentMobileSlide - 1 + mobileCarruselData.length) % mobileCarruselData.length;
                updateMobileCarrusel();
            }
            
            function goToMobileSlide(index) {
                currentMobileSlide = index;
                updateMobileCarrusel();
            }
            
            function updateMobileCarrusel() {
                const slides = document.querySelectorAll('.carrusel-slide');
                const indicators = document.querySelectorAll('.carrusel-indicator');
                
                slides.forEach(slide => slide.classList.remove('active'));
                indicators.forEach(indicator => indicator.classList.remove('active'));
                
                if (slides[currentMobileSlide]) slides[currentMobileSlide].classList.add('active');
                if (indicators[currentMobileSlide]) indicators[currentMobileSlide].classList.add('active');
            }
            
            function startMobileAutoPlay() {
                if (mobileIsAutoPlay) {
                    mobileAutoPlayInterval = setInterval(showMobileNextSlide, 5000);
                }
            }
            
            // ðŸ”’ Bloquear clic derecho SOLO en el menÃº mÃ³vil
            mobileSidebar.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            function openWhatsApp() {
                const phoneNumber = '+524421974414';
                const message = 'Hola, necesito ayuda en BB Analytics 360';
                const url = 'https://wa.me/' + phoneNumber + '?text=' + encodeURIComponent(message);
                window.open(url, '_blank');
            }
            
            function toggleMobileSidebar() {
                isSidebarOpen = !isSidebarOpen;
                mobileSidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
                mobileIframeContainer.classList.toggle('sidebar-open');
                
                if (isSidebarOpen) {
                    mobileToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                } else {
                    mobileToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                }
            }
            
            function loadMobileDashboard(dashboardUrl, dashboardKey) {
                // Mostrar loading
                mobileIframeLoading.style.display = 'block';
                
                // Si es el carrusel
                if (dashboardUrl === 'carrusel_integrado') {
                    initMobileCarrusel();
                    mobileIframeLoading.style.display = 'none';
                    
                    // Actualizar menÃº
                    mobileMenuItems.forEach(menuItem => {
                        menuItem.classList.remove('active');
                        if (menuItem.getAttribute('data-src') === 'carrusel_integrado') {
                            menuItem.classList.add('active');
                        }
                    });
                } 
                // Si es un dashboard externo
                else if (dashboardUrl && dashboardUrl !== '#') {
                    // Crear iframe
                    mobileContentContainer.innerHTML = `<iframe class="mobile-iframe" id="mobileIframe" src="${dashboardUrl}"></iframe>`;
                    
                    // Ocultar loading cuando el iframe cargue
                    const iframe = document.getElementById('mobileIframe');
                    iframe.onload = function() {
                        mobileIframeLoading.style.display = 'none';
                    };
                    
                    // Detener carrusel si estaba activo
                    if (mobileAutoPlayInterval) {
                        clearInterval(mobileAutoPlayInterval);
                    }
                }
                
                // Ocultar sidebar si estÃ¡ abierto
                if (isSidebarOpen) {
                    toggleMobileSidebar();
                }
            }
            
            // ðŸšª FUNCIÃ“N SIMPLIFICADA PARA REGISTRAR LOGOUT MÃ“VIL
            async function registerMobileLogout() {
                try {
                    console.log('ðŸšª Registrando logout mÃ³vil por botÃ³n');
                    
                    // Enviar al logger
                    await logger.log('logout', null, currentUser, { 
                        logoutType: 'button_click',
                        device: 'mobile',
                        timestamp: new Date().toISOString()
                    });
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error registrando logout mÃ³vil:', error);
                    return false;
                }
            }
            
            mobileToggleBtn.addEventListener('click', toggleMobileSidebar);
            mobileOverlay.addEventListener('click', toggleMobileSidebar);
            
            mobileMenuItems.forEach(item => {
                item.addEventListener('click', async function() {
                    const dashboardUrl = this.getAttribute('data-src');
                    
                    if (dashboardUrl) {
                        // Obtener quÃ© dashboard se estÃ¡ accediendo
                        const dashboardKey = Object.keys(dashboardUrls).find(key => 
                            dashboardUrls[key] === dashboardUrl
                        ) || (dashboardUrl === 'carrusel_integrado' ? 'principal' : null);
                        
                        // Actualizar estado activo
                        mobileMenuItems.forEach(menuItem => {
                            menuItem.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // Registrar acceso si no es el carrusel
                        if (dashboardKey && dashboardKey !== 'principal') {
                            await logger.log('dashboard_view', dashboardKey, currentUser, {
                                source: 'mobile_menu_click',
                                timestamp: new Date().toISOString()
                            });
                        }
                        
                        // Cargar dashboard
                        loadMobileDashboard(dashboardUrl, dashboardKey);
                    }
                });
            });
            
            mobileWhatsappBtn.addEventListener('click', function() {
                openWhatsApp();
            });
            
            // BotÃ³n de cerrar sesiÃ³n
            mobileExitBtn.addEventListener('click', async function() {
                if (confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) {
                    await registerMobileLogout();
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            });
            
            // Inicializar carrusel automÃ¡ticamente
            initMobileCarrusel();
        }

        // FunciÃ³n para generar el HTML del dashboard para PC
        function generateDashboardHTML() {
            let menuItemsHTML = '';
            
            // Dashboard principal (carrusel integrado)
            if (currentUserPermissions.includes('principal')) {
                menuItemsHTML += `
                    <button class="menu-item active" data-src="carrusel_integrado">
                        <i class="${dashboardIcons.principal}"></i> ${dashboardNames.principal}
                    </button>
                `;
            }
            
            // Otros dashboards
            const otherDashboards = currentUserPermissions.filter(d => d !== 'principal' && d !== 'diccionario');
            if (otherDashboards.length > 0) {
                menuItemsHTML += `<div class="menu-section">Dashboards</div>`;
                
                otherDashboards.forEach(dashboard => {
                    if (dashboardUrls[dashboard]) {
                        menuItemsHTML += `
                            <button class="menu-item" data-src="${dashboardUrls[dashboard]}">
                                <i class="${dashboardIcons[dashboard]}"></i> ${dashboardNames[dashboard]}
                            </button>
                        `;
                    }
                });
            }
            
            // Herramientas
            menuItemsHTML += `<div class="menu-section">Herramientas</div>`;
            
            // Diccionario KPI's
            if (currentUserPermissions.includes('diccionario')) {
                menuItemsHTML += `
                    <button class="menu-item" data-src="${dashboardUrls.diccionario}">
                        <i class="${dashboardIcons.diccionario}"></i> ${dashboardNames.diccionario}
                    </button>
                `;
            }
            
            // BotÃ³n de ayuda
            menuItemsHTML += `
                <button class="menu-item" id="whatsappBtn">
                    <i class="fab fa-whatsapp"></i> Ayuda
                </button>
            `;
            
            // Convertir las constantes a JSON para pasarlas al dashboard
            const dashboardUrlsJson = JSON.stringify(dashboardUrls);
            const dashboardNamesJson = JSON.stringify(dashboardNames);
            const dashboardIconsJson = JSON.stringify(dashboardIcons);
            const currentUserPermissionsJson = JSON.stringify(currentUserPermissions);
            const dashboardImagesJson = JSON.stringify(dashboardImages);
            const dashboardDescriptionsJson = JSON.stringify(dashboardDescriptions);
            
            return `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>BB Analytics 360 - Big Bola Casinos</title>
                    <link rel="icon" type="image/png" href="https://i.postimg.cc/QCN4dPG1/analisis-de-datos.png">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        }
                        
                        body {
                            background-color: #f5f5f5;
                            overflow: hidden;
                            margin: 0;
                            padding: 0;
                        }
                        
                        .container {
                            width: 100vw;
                            height: 100vh;
                            background-color: #fff;
                            display: flex;
                            flex-direction: column;
                            position: relative;
                        }
                        
                        /* ðŸ”¹ BOTÃ“N HAMBURGUESA SUPERIOR IZQUIERDA */
                        .floating-toggle {
                            position: fixed;
                            top: 20px;
                            left: 20px;
                            width: 50px;
                            height: 50px;
                            background: rgba(26, 58, 143, 0.8);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            cursor: pointer;
                            z-index: 1001;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 20px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: all 0.3s ease;
                        }
                        
                        .floating-toggle:hover {
                            background: rgba(26, 58, 143, 0.9);
                            transform: scale(1.05);
                        }
                        
                        /* ðŸ”¹ SIDEBAR (MENÃš LATERAL) */
                        .sidebar {
                            position: fixed;
                            top: 0;
                            left: -320px;
                            width: 320px;
                            height: 100vh;
                            background: #152c6e;
                            z-index: 1002;
                            transition: left 0.3s ease;
                            overflow-y: auto;
                            padding: 20px;
                            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
                            display: flex;
                            flex-direction: column;
                        }
                        
                        .sidebar.active { left: 0; }
                        
                        .sidebar-overlay {
                            display: none;
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.5);
                            z-index: 1001;
                        }
                        
                        .sidebar-overlay.active { display: block; }
                        
                        .sidebar-header {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            padding: 20px 0;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                            margin-bottom: 20px;
                        }
                        
                        .sidebar-logo {
                            height: 60px;
                            width: auto;
                            margin-bottom: 15px;
                        }
                        
                        .sidebar-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: white;
                            text-align: center;
                            line-height: 1.2;
                        }
                        
                        .sidebar-subtitle {
                            font-size: 14px;
                            color: #FFD700;
                            text-align: center;
                            margin-top: 5px;
                        }
                        
                        .user-info {
                            margin-top: 10px;
                            font-size: 12px;
                            color: #FFD700;
                            text-align: center;
                        }
                        
                        .menu-section {
                            color: #FFD700;
                            font-weight: bold;
                            margin: 20px 0 10px;
                            padding-bottom: 5px;
                            border-bottom: 1px solid rgba(255,255,255,0.2);
                            font-size: 16px;
                        }
                        
                        .menu-item {
                            display: block;
                            width: 100%;
                            padding: 12px 15px;
                            margin-bottom: 8px;
                            background: rgba(255,255,255,0.1);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            text-align: left;
                            cursor: pointer;
                            transition: background 0.3s, transform 0.2s;
                            font-size: 15px;
                        }
                        
                        .menu-item:hover { 
                            background: rgba(255,255,255,0.2); 
                            transform: translateX(5px);
                        }
                        
                        .menu-item.active {
                            background: rgba(255,215,0,0.3);
                            border-left: 3px solid #FFD700;
                            font-weight: bold;
                        }
                        
                        .menu-item i {
                            margin-right: 10px;
                            width: 20px;
                            text-align: center;
                        }
                        
                        .sidebar-footer {
                            margin-top: auto;
                            padding-top: 20px;
                            border-top: 1px solid rgba(255,255,255,0.2);
                        }
                        
                        .exit-btn {
                            display: block;
                            width: 100%;
                            padding: 12px 15px;
                            background: rgba(255, 0, 0, 0.2);
                            color: white;
                            border: none;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 15px;
                            transition: background 0.3s;
                            text-align: center;
                        }
                        
                        .exit-btn:hover { background: rgba(255, 0, 0, 0.3); }
                        
                        /* ðŸ”¹ CONTENEDOR DEL IFRAME (DASHBOARD) */
                        .iframe-container {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: white;
                            transition: left 0.3s ease;
                            z-index: 1000;
                        }
                        
                        .iframe-container.sidebar-open {
                            left: 320px;
                            width: calc(100% - 320px);
                        }
                        
                        /* ðŸ”¹ ESTILOS PARA CARRUSEL INTEGRADO */
                        .carrusel-container {
                            width: 100%;
                            height: 100%;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            background: linear-gradient(135deg, #2a4b9f 0%, #1a3a8f 100%);
                            overflow: hidden;
                        }
                        
                        .carrusel-title {
                            color: white;
                            font-size: 32px;
                            margin-bottom: 30px;
                            text-align: center;
                            padding: 0 20px;
                        }
                        
                        .carrusel-title span {
                            color: #FFD700;
                            font-weight: bold;
                        }
                        
                        .carrusel-slider {
                            width: 90%;
                            max-width: 1200px;
                            height: 70vh;
                            position: relative;
                            overflow: hidden;
                            border-radius: 20px;
                            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
                            background: linear-gradient(135deg, rgba(26, 58, 143, 0.7) 0%, rgba(21, 44, 110, 0.8) 100%);
                        }
                        
                        .carrusel-slide {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            opacity: 0;
                            transition: opacity 0.8s ease-in-out;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            background-color: transparent;
                            padding: 40px;
                            text-align: center;
                        }
                        
                        .carrusel-slide.active {
                            opacity: 1;
                        }
                        
                        .carrusel-slide img {
                            max-width: 50%;
                            max-height: 50%;
                            object-fit: contain;
                            border-radius: 15px;
                            margin-bottom: 25px;
                            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
                            cursor: pointer;
                            transition: transform 0.3s ease, box-shadow 0.3s ease;
                            z-index: 10;
                            position: relative;
                        }

                        .carrusel-slide img:hover {
                            transform: scale(1.02);
                            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
                        }
                        
                        .carrusel-slide .dashboard-title {
                            color: white;
                            font-size: 28px;
                            margin-bottom: 15px;
                            font-weight: bold;
                            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
                        }
                        
                        .carrusel-slide .dashboard-desc {
                            color: #FFD700;
                            font-size: 18px;
                            line-height: 1.6;
                            max-width: 800px;
                            margin: 0 auto 20px;
                            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
                        }
                        
                        .carrusel-indicators {
                            display: flex;
                            justify-content: center;
                            gap: 15px;
                            margin-top: 30px;
                            position: absolute;
                            bottom: 30px;
                            left: 0;
                            right: 0;
                            z-index: 15;
                        }
                        
                        .carrusel-indicator {
                            width: 15px;
                            height: 15px;
                            background-color: rgba(255, 255, 255, 0.4);
                            border-radius: 50%;
                            cursor: pointer;
                            transition: background-color 0.3s, transform 0.3s;
                        }
                        
                        .carrusel-indicator.active {
                            background-color: #FFD700;
                            transform: scale(1.3);
                        }
                        
                        .carrusel-nav {
                            position: absolute;
                            top: 50%;
                            transform: translateY(-50%);
                            background-color: rgba(21, 44, 110, 0.9);
                            color: white;
                            border: none;
                            width: 60px;
                            height: 60px;
                            border-radius: 50%;
                            cursor: pointer;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            font-size: 24px;
                            z-index: 15;
                            transition: background-color 0.3s, transform 0.3s;
                            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                        }
                        
                        .carrusel-nav:hover {
                            background-color: rgba(21, 44, 110, 1);
                            transform: translateY(-50%) scale(1.1);
                        }
                        
                        .carrusel-prev {
                            left: 30px;
                        }
                        
                        .carrusel-next {
                            right: 30px;
                        }
                        
                        .carrusel-dashboard-badge {
                            background-color: #152c6e;
                            color: white;
                            padding: 8px 15px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: bold;
                            margin-top: 15px;
                            display: inline-block;
                        }
                        
                        .carrusel-slide-description {
                            font-style: italic;
                            color: #FFD700;
                            margin-top: 10px;
                            font-size: 16px;
                            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
                        }
                        
                        .carrusel-permission-info {
                            color: #FFD700;
                            font-size: 16px;
                            margin-top: 20px;
                            text-align: center;
                        }
                        
                        /* ðŸ”¹ ESTILOS PARA IMÃGENES DE PREVIO/SIGUIENTE */
                        .preview-images {
                            position: absolute;
                            top: 50%;
                            transform: translateY(-50%);
                            width: 25%;
                            max-width: 300px;
                            height: 50%;
                            object-fit: contain;
                            border-radius: 10px;
                            opacity: 0.7;
                            z-index: 5;
                            pointer-events: none;
                            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
                            filter: blur(2px);
                            transition: opacity 0.5s ease;
                        }
                        
                        .preview-prev {
                            left: 5%;
                        }
                        
                        .preview-next {
                            right: 5%;
                        }
                        
                        /* ðŸ”¹ MEJORAS VISUALES */
                        .carrusel-slider::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: linear-gradient(135deg, 
                                rgba(255, 215, 0, 0.1) 0%, 
                                rgba(26, 58, 143, 0.3) 50%,
                                rgba(21, 44, 110, 0.2) 100%);
                            z-index: 1;
                        }
                        
                        iframe {
                            width: 100%;
                            height: 100%;
                            border: none;
                            transition: opacity 0.3s;
                        }
                        
                        /* Estilo para el mensaje de menÃº deshabilitado */
                        .context-menu-message {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            background: rgba(0,0,0,0.7);
                            color: white;
                            padding: 10px;
                            border-radius: 5px;
                            z-index: 10000;
                            font-size: 14px;
                            display: none;
                            animation: fadeInOut 3s ease-in-out;
                        }
                        
                        @keyframes fadeInOut {
                            0% { opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { opacity: 0; }
                        }

                        /* Loading spinner para iframe */
                        .iframe-loading {
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            text-align: center;
                            z-index: 100;
                            display: none;
                        }

                        .spinner {
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #152c6e;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 15px;
                        }

                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                </head>
                <body>
                    <div class="context-menu-message" id="contextMenuMessage">MenÃº contextual deshabilitado</div>
                    <div class="container">
                        <!-- BotÃ³n hamburguesa superior izquierda -->
                        <button class="floating-toggle" id="toggleBtn">
                            <i class="fas fa-bars"></i>
                        </button>
                        
                        <!-- Overlay para cerrar menÃº -->
                        <div class="sidebar-overlay" id="overlay"></div>
                        
                        <!-- Sidebar con menÃº -->
                        <div class="sidebar" id="sidebar">
                            <div class="sidebar-header">
                                <img src="https://i.postimg.cc/hGqNYsNp/Isotipo-Perfiles-Marmol01-Photoroom.png" alt="Big Bola Casinos" class="sidebar-logo">
                                <div class="sidebar-title">
                                    <div>BB Analytics 360 <span style="font-size: 12px; color: #FFD700; margin-left: 5px;">V1.5</span></div>
                                    <div class="sidebar-subtitle">Plataforma de Business Intelligence</div>
                                </div>
                                <div class="user-info">
                                    Usuario: ${currentUser}<br>
                                    Dashboards: ${currentUserPermissions.length} disponibles
                                </div>
                            </div>
                            ${menuItemsHTML}
                            <div class="sidebar-footer">
                                <button class="exit-btn" id="exitBtn">
                                    <i class="fas fa-sign-out-alt"></i> Salir
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contenedor principal -->
                        <div class="iframe-container" id="iframeContainer">
                            <div class="iframe-loading" id="iframeLoading">
                                <div class="spinner"></div>
                                <p>Cargando dashboard...</p>
                            </div>
                            <div id="contentContainer" class="carrusel-container">
                                <h1 class="carrusel-title"> <span> BB Analytics 360 </span> <span style="font-size: 16px; color: #FFD700; font-weight: normal; margin-left: 5px;">V1.5</span> </h1>
                                <div class="carrusel-permission-info" id="carruselPermissionInfo">
                                    <i class="fas fa-user-check"></i> Cargando informaciÃ³n de usuario...
                                </div>
                                <div class="carrusel-slider" id="carruselSlider">
                                    <div style="text-align: center; padding: 40px; color: white;">
                                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                                        <p>Cargando carrusel de dashboards...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>
                        // ðŸ”§ VARIABLES GLOBALES PARA ESTE SCRIPT
                        const dashboardUrls = ${dashboardUrlsJson};
                        const dashboardNames = ${dashboardNamesJson};
                        const dashboardIcons = ${dashboardIconsJson};
                        const dashboardImages = ${dashboardImagesJson};
                        const dashboardDescriptions = ${dashboardDescriptionsJson};
                        const currentUser = "${currentUser}";
                        const currentUserPermissions = ${currentUserPermissionsJson};
                        const currentSessionId = "${currentSessionId}";
                        
                        // Variables para control del carrusel
                        let currentSlide = 0;
                        let autoPlayInterval;
                        let isAutoPlay = true;
                        let carruselData = [];
                        
                        // Variable global para controlar logout
                        window.logoutRegistered = false;
                        
                        // ðŸ”§ FUNCIÃ“N PARA GENERAR LOS DATOS DEL CARRUSEL
                        function generateCarruselData() {
                            const data = [];
                            
                            // Para cada dashboard permitido, crear una diapositiva
                            currentUserPermissions.forEach(dashboardKey => {
                                if (dashboardKey !== 'diccionario' && dashboardUrls[dashboardKey]) {
                                    const imageUrl = dashboardImages[dashboardKey] || 'https://i.postimg.cc/QCN4dPG1/analisis-de-datos.png';
                                    const description = dashboardDescriptions[dashboardKey] || 'Dashboard de Business Intelligence';
                                    
                                    data.push({
                                        key: dashboardKey,
                                        title: dashboardNames[dashboardKey],
                                        image: imageUrl,
                                        description: description,
                                        icon: dashboardIcons[dashboardKey],
                                        url: dashboardUrls[dashboardKey]
                                    });
                                }
                            });
                            
                            return data;
                        }
                        
                        // ðŸ”§ FUNCIÃ“N PARA INICIALIZAR EL CARRUSEL
                        function initCarrusel() {
                            carruselData = generateCarruselData();
                            
                            // Actualizar informaciÃ³n de permisos
                            const permissionInfo = document.getElementById('carruselPermissionInfo');
                            if (permissionInfo) {
                                permissionInfo.innerHTML = \`
                                    <i class="fas fa-user-check"></i> Usuario: \${currentUser} | 
                                    <i class="fas fa-chart-bar"></i> Dashboards disponibles: \${carruselData.length}
                                \`;
                            }
                            
                            // Si no hay dashboards permitidos, mostrar mensaje
                            if (carruselData.length === 0) {
                                document.getElementById('contentContainer').innerHTML = \`
                                    <div style="text-align: center; color: white; padding: 40px;">
                                        <i class="fas fa-exclamation-triangle" style="font-size: 60px; margin-bottom: 20px; color: #FFD700;"></i>
                                        <h2 style="font-size: 28px; margin-bottom: 15px;">No hay dashboards disponibles</h2>
                                        <p style="font-size: 18px;">No tienes permisos para acceder a ningÃºn dashboard.</p>
                                        <p style="font-size: 16px; margin-top: 20px; color: #FFD700;">
                                            Contacta al administrador para solicitar acceso.
                                        </p>
                                    </div>
                                \`;
                                return;
                            }
                            
                            // Generar HTML del carrusel
                            const slidesHTML = carruselData.map((slide, index) => \`
                                <div class="carrusel-slide \${index === 0 ? 'active' : ''}" data-index="\${index}">
                                    <img src="\${slide.image}" alt="\${slide.title}" data-key="\${slide.key}">
                                    <div class="dashboard-title">\${slide.title}</div>
                                    <div class="dashboard-desc">\${slide.description}</div>
                                    <p class="carrusel-slide-description">
                                        Haz clic en la imagen para acceder al dashboard
                                    </p>
                                </div>
                            \`).join('');
                            
                            const indicatorsHTML = carruselData.map((_, index) => \`
                                <div class="carrusel-indicator \${index === 0 ? 'active' : ''}" data-index="\${index}"></div>
                            \`).join('');
                            
                            document.getElementById('carruselSlider').innerHTML = \`
                                <button class="carrusel-nav carrusel-prev">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="carrusel-nav carrusel-next">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                \${slidesHTML}
                                <div class="carrusel-indicators">
                                    \${indicatorsHTML}
                                </div>
                            \`;
                            
                            // Crear imÃ¡genes de preview (anterior y siguiente)
                            createPreviewImages();
                            
                            // Inicializar eventos del carrusel
                            setupCarruselEvents();
                            startAutoPlay();
                            
                            // Actualizar imÃ¡genes de preview
                            updatePreviewImages();
                        }
                        
                        // ðŸ”§ FUNCIÃ“N PARA CREAR IMÃGENES DE PREVIO/SIGUIENTE
                        function createPreviewImages() {
                            const carruselSlider = document.getElementById('carruselSlider');
                            
                            // Crear imagen para dashboard anterior
                            const previewPrev = document.createElement('img');
                            previewPrev.className = 'preview-images preview-prev';
                            previewPrev.alt = 'Dashboard anterior';
                            
                            // Crear imagen para dashboard siguiente
                            const previewNext = document.createElement('img');
                            previewNext.className = 'preview-images preview-next';
                            previewNext.alt = 'Dashboard siguiente';
                            
                            // Agregar al carrusel
                            carruselSlider.appendChild(previewPrev);
                            carruselSlider.appendChild(previewNext);
                        }
                        
                        // ðŸ”§ FUNCIÃ“N PARA ACTUALIZAR IMÃGENES DE PREVIO/SIGUIENTE
                        function updatePreviewImages() {
                            const previewPrev = document.querySelector('.preview-prev');
                            const previewNext = document.querySelector('.preview-next');
                            
                            if (!previewPrev || !previewNext || carruselData.length === 0) return;
                            
                            // Calcular Ã­ndices de anterior y siguiente
                            const prevIndex = (currentSlide - 1 + carruselData.length) % carruselData.length;
                            const nextIndex = (currentSlide + 1) % carruselData.length;
                            
                            // Actualizar imÃ¡genes
                            if (carruselData[prevIndex]) {
                                previewPrev.src = carruselData[prevIndex].image;
                                previewPrev.style.opacity = '0.6';
                            }
                            
                            if (carruselData[nextIndex]) {
                                previewNext.src = carruselData[nextIndex].image;
                                previewNext.style.opacity = '0.6';
                            }
                        }
                        
                        // ðŸ”§ FUNCIÃ“N PARA CONFIGURAR EVENTOS DEL CARRUSEL
                        function setupCarruselEvents() {
                            const prevBtn = document.querySelector('.carrusel-prev');
                            const nextBtn = document.querySelector('.carrusel-next');
                            const indicators = document.querySelectorAll('.carrusel-indicator');
                            const slideImages = document.querySelectorAll('.carrusel-slide img');
                            
                            if (prevBtn) prevBtn.addEventListener('click', showPrevSlide);
                            if (nextBtn) nextBtn.addEventListener('click', showNextSlide);
                            
                            indicators.forEach(indicator => {
                                indicator.addEventListener('click', function() {
                                    const index = parseInt(this.getAttribute('data-index'));
                                    goToSlide(index);
                                });
                            });
                            
                            slideImages.forEach(img => {
                                img.addEventListener('click', function() {
                                    const dashboardKey = this.getAttribute('data-key');
                                    if (dashboardKey && dashboardUrls[dashboardKey]) {
                                        // âœ… ENVIAR MENSAJE AL PADRE PARA LOGGING EN AIRTABLE
                                        if (window.opener && !window.opener.closed) {
                                            window.opener.postMessage({
                                                type: 'dashboard_access',
                                                dashboardKey: dashboardKey,
                                                user: currentUser,
                                                sessionId: currentSessionId,
                                                timestamp: new Date().toISOString(),
                                                dashboardName: dashboardNames[dashboardKey] || dashboardKey,
                                                action: 'dashboard_view'
                                            }, '*');
                                        }
                                        
                                        console.log('ðŸ“Š Dashboard accedido:', dashboardKey);
                                        
                                        // Cargar el dashboard
                                        loadDashboard(dashboardUrls[dashboardKey], dashboardKey);
                                    }
                                });
                                
                                // Pausar carrusel al hacer hover
                                img.addEventListener('mouseenter', function() {
                                    if (autoPlayInterval) {
                                        clearInterval(autoPlayInterval);
                                        isAutoPlay = false;
                                    }
                                });
                                
                                // Reanudar carrusel al quitar el cursor
                                img.addEventListener('mouseleave', function() {
                                    if (!isAutoPlay) {
                                        isAutoPlay = true;
                                        startAutoPlay();
                                    }
                                });
                            });
                        }
                        
                        // ðŸ”§ FUNCIONES DE CONTROL DEL CARRUSEL
                        function showNextSlide() {
                            currentSlide = (currentSlide + 1) % carruselData.length;
                            updateCarrusel();
                            updatePreviewImages();
                        }
                        
                        function showPrevSlide() {
                            currentSlide = (currentSlide - 1 + carruselData.length) % carruselData.length;
                            updateCarrusel();
                            updatePreviewImages();
                        }
                        
                        function goToSlide(index) {
                            currentSlide = index;
                            updateCarrusel();
                            updatePreviewImages();
                        }
                        
                        function updateCarrusel() {
                            const slides = document.querySelectorAll('.carrusel-slide');
                            const indicators = document.querySelectorAll('.carrusel-indicator');
                            
                            slides.forEach(slide => slide.classList.remove('active'));
                            indicators.forEach(indicator => indicator.classList.remove('active'));
                            
                            if (slides[currentSlide]) slides[currentSlide].classList.add('active');
                            if (indicators[currentSlide]) indicators[currentSlide].classList.add('active');
                        }
                        
                        function startAutoPlay() {
                            if (isAutoPlay && carruselData.length > 1) {
                                autoPlayInterval = setInterval(showNextSlide, 5000);
                            }
                        }
                        
                        // âœ… FUNCIÃ“N PARA CARGAR DASHBOARD
                        function loadDashboard(dashboardUrl, dashboardKey) {
                            const iframeLoading = document.getElementById('iframeLoading');
                            const contentContainer = document.getElementById('contentContainer');
                            const menuItems = document.querySelectorAll('.menu-item');
                            
                            // Mostrar loading
                            iframeLoading.style.display = 'block';
                            
                            // Si es el carrusel
                            if (dashboardUrl === 'carrusel_integrado') {
                                // Reconstruir el carrusel completamente
                                contentContainer.innerHTML = \`
                                    <h1 class="carrusel-title"> <span> BB Analytics 360 </span> <span style="font-size: 16px; color: #FFD700; font-weight: normal; margin-left: 5px;">V1.5</span> </h1>
                                    <div class="carrusel-permission-info" id="carruselPermissionInfo">
                                        <i class="fas fa-user-check"></i> Cargando informaciÃ³n...
                                    </div>
                                    <div class="carrusel-slider" id="carruselSlider">
                                        <div style="text-align: center; padding: 40px; color: white;">
                                            <div class="spinner" style="margin: 0 auto 20px;"></div>
                                            <p>Cargando carrusel de dashboards...</p>
                                        </div>
                                    </div>
                                \`;
                                
                                // Inicializar el carrusel
                                setTimeout(() => {
                                    initCarrusel();
                                    iframeLoading.style.display = 'none';
                                }, 100);
                                
                                // Actualizar menÃº
                                menuItems.forEach(menuItem => {
                                    menuItem.classList.remove('active');
                                    if (menuItem.getAttribute('data-src') === 'carrusel_integrado') {
                                        menuItem.classList.add('active');
                                    }
                                });
                            } 
                            // Si es un dashboard externo
                            else if (dashboardUrl && dashboardUrl !== '#') {
                                // Crear iframe
                                contentContainer.innerHTML = \`<iframe id="dashboardFrame" src="\${dashboardUrl}"></iframe>\`;
                                
                                // Ocultar loading cuando el iframe cargue
                                const iframe = document.getElementById('dashboardFrame');
                                iframe.onload = function() {
                                    iframeLoading.style.display = 'none';
                                };
                                
                                // Detener carrusel si estaba activo
                                if (autoPlayInterval) {
                                    clearInterval(autoPlayInterval);
                                }
                            }
                            
                            // Ocultar sidebar si estÃ¡ abierto
                            const sidebar = document.getElementById('sidebar');
                            if (sidebar.classList.contains('active')) {
                                toggleSidebar();
                            }
                        }
                        
                        // ðŸšª FUNCIÃ“N PARA REGISTRAR LOGOUT EN AIRTABLE
                        function registerLogout() {
                            if (window.logoutRegistered) {
                                console.log('âš ï¸ Logout ya registrado, ignorando...');
                                return true;
                            }
                            
                            try {
                                console.log('ðŸšª Registrando logout por botÃ³n');
                                
                                // Marcar inmediatamente que ya se registrÃ³ logout
                                window.logoutRegistered = true;
                                
                                // Crear datos de logout
                                const logoutData = {
                                    user: currentUser,
                                    action: 'logout',
                                    logoutType: 'button_click',
                                    timestamp: new Date().toISOString(),
                                    sessionId: currentSessionId,
                                    deviceType: 'desktop',
                                    registeredAt: Date.now(),
                                    sessionDuration: Date.now() - parseInt(currentSessionId.split('_')[1])
                                };
                                
                                // Enviar mensaje al padre (login page) para logging en Airtable
                                if (window.opener && !window.opener.closed) {
                                    try {
                                        window.opener.postMessage({
                                            type: 'logout',
                                            ...logoutData,
                                            source: 'dashboard_button'
                                        }, '*');
                                        
                                        console.log('ðŸ“¤ Mensaje de logout enviado al padre para Airtable');
                                        
                                    } catch (error) {
                                        console.warn('Error enviando mensaje al padre:', error);
                                        localStorage.setItem('pending_logout', JSON.stringify(logoutData));
                                    }
                                } else {
                                    localStorage.setItem('pending_logout', JSON.stringify(logoutData));
                                }
                                
                                console.log('âœ… Logout registrado exitosamente');
                                return true;
                                
                            } catch (error) {
                                console.error('âŒ Error registrando logout:', error);
                                return false;
                            }
                        }
                        
                        document.addEventListener('DOMContentLoaded', function() {
                            const toggleBtn = document.getElementById('toggleBtn');
                            const sidebar = document.getElementById('sidebar');
                            const overlay = document.getElementById('overlay');
                            const iframeContainer = document.getElementById('iframeContainer');
                            const menuItems = document.querySelectorAll('.menu-item');
                            const whatsappBtn = document.getElementById('whatsappBtn');
                            const exitBtn = document.getElementById('exitBtn');
                            const iframeLoading = document.getElementById('iframeLoading');
                            const contextMenuMessage = document.getElementById('contextMenuMessage');
                            
                            let isSidebarOpen = false;
                            
                            // ðŸ”’ FUNCIONES DE SEGURIDAD
                            function blockRightClickOnSidebar(e) {
                                e.preventDefault();
                                showContextMenuMessage();
                                return false;
                            }
                            
                            function showContextMenuMessage() {
                                contextMenuMessage.style.display = 'block';
                                setTimeout(() => {
                                    contextMenuMessage.style.display = 'none';
                                }, 3000);
                            }
                            
                            function applySecurityBlocks() {
                                sidebar.addEventListener('contextmenu', blockRightClickOnSidebar);
                            }
                            
                            // ðŸ“± FUNCIONES DE LA APLICACIÃ“N
                            function openWhatsApp() {
                                const phoneNumber = '+524421974414';
                                const message = 'Hola, necesito ayuda en BB Analytics 360';
                                const url = 'https://wa.me/' + phoneNumber + '?text=' + encodeURIComponent(message);
                                window.open(url, '_blank');
                            }
                            
                            function toggleSidebar() {
                                isSidebarOpen = !isSidebarOpen;
                                sidebar.classList.toggle('active');
                                overlay.classList.toggle('active');
                                iframeContainer.classList.toggle('sidebar-open');
                                
                                toggleBtn.innerHTML = isSidebarOpen ? 
                                    '<i class="fas fa-times"></i>' : 
                                    '<i class="fas fa-bars"></i>';
                            }
                            
                            function logout() {
                                if (confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) {
                                    // âœ… REGISTRAR LOGOUT POR BOTÃ“N EN AIRTABLE
                                    const registered = registerLogout();
                                    
                                    if (registered) {
                                        // Cerrar despuÃ©s de un breve delay para permitir el logging
                                        setTimeout(() => {
                                            try {
                                                window.close();
                                            } catch (error) {
                                                console.warn('No se pudo cerrar ventana:', error);
                                                window.location.href = window.opener ? window.opener.location.href : 'about:blank';
                                            }
                                        }, 1000);
                                    } else {
                                        alert('Error registrando logout. La ventana se cerrarÃ¡ de todos modos.');
                                        setTimeout(() => {
                                            try {
                                                window.close();
                                            } catch (error) {
                                                window.location.href = 'about:blank';
                                            }
                                        }, 100);
                                    }
                                }
                            }
                            
                            // ðŸŽ¯ EVENT LISTENERS
                            toggleBtn.addEventListener('click', toggleSidebar);
                            overlay.addEventListener('click', toggleSidebar);
                            
                            // âœ… CORRECCIÃ“N: Event listeners para los botones del menÃº
                            menuItems.forEach(item => {
                                item.addEventListener('click', function() {
                                    const dashboardUrl = this.getAttribute('data-src');
                                    const dashboardKey = Object.keys(dashboardUrls).find(key => 
                                        dashboardUrls[key] === dashboardUrl
                                    ) || (dashboardUrl === 'carrusel_integrado' ? 'principal' : null);
                                    
                                    if (dashboardUrl) {
                                        // Actualizar estado activo
                                        menuItems.forEach(menuItem => {
                                            menuItem.classList.remove('active');
                                        });
                                        this.classList.add('active');
                                        
                                        // Enviar log si no es el carrusel
                                        if (dashboardKey && dashboardKey !== 'principal' && window.opener && !window.opener.closed) {
                                            window.opener.postMessage({
                                                type: 'log_dashboard_view',
                                                dashboardKey: dashboardKey,
                                                user: currentUser,
                                                sessionId: currentSessionId,
                                                timestamp: new Date().toISOString()
                                            }, '*');
                                        }
                                        
                                        // Cargar el dashboard usando la funciÃ³n global loadDashboard
                                        loadDashboard(dashboardUrl, dashboardKey);
                                    }
                                });
                            });
                            
                            // BotÃ³n de WhatsApp
                            if (whatsappBtn) {
                                whatsappBtn.addEventListener('click', openWhatsApp);
                            }
                            
                            // BotÃ³n de salir
                            exitBtn.addEventListener('click', logout);
                            
                            // ðŸ“‹ INICIALIZACIÃ“N
                            applySecurityBlocks();
                            
                            // Inicializar carrusel automÃ¡ticamente
                            initCarrusel();
                            
                            // Registrar cierre de ventana/pestaÃ±a
                            window.addEventListener('beforeunload', function(e) {
                                if (!window.logoutRegistered) {
                                    console.log('âš ï¸ Ventana cerrada sin logout formal');
                                    
                                    // Intentar registrar como logout automÃ¡tico
                                    if (window.opener && !window.opener.closed) {
                                        window.opener.postMessage({
                                            type: 'logout',
                                            user: currentUser,
                                            action: 'logout',
                                            logoutType: 'window_close',
                                            sessionId: currentSessionId,
                                            timestamp: new Date().toISOString(),
                                            source: 'window_beforeunload'
                                        }, '*');
                                    }
                                }
                            });
                        });
                    <\/script>
                </body>
                </html>
            `;
        }
    </script>
</body>
</html>